# Ralph Progress Log

## Codebase Patterns
- Backend FastAPI app lives in `backend/app/main.py`
- Python dependencies in `backend/requirements.txt`
- Use `python3 -m mypy <file> --ignore-missing-imports` for typechecking
- Use `--break-system-packages` flag when installing pip packages in this environment
- Uvicorn runs the app: `python3 -m uvicorn app.main:app --port 8000`
- Import settings: `from app.config import settings`
- Import database: `from app.database import engine, SessionLocal, Base, get_db`
- Import models: `from app.models import Project` (add new models to models/__init__.py)
- Run Alembic migrations from backend directory: `cd backend && python3 -m alembic upgrade head`
- Create new migrations: `cd backend && python3 -m alembic revision --autogenerate -m "description"`
- Always import models in `alembic/env.py` for autogenerate to detect new models
- Import schemas: `from app.schemas import ProjectCreate, ProjectResponse` etc.
- Pydantic v2 uses `model_config = {"from_attributes": True}` for ORM conversion
- Routers go in `backend/app/routers/`, export from `__init__.py`, include in main.py
- Use `APIRouter(prefix="/api/...", tags=["..."])` for route grouping
- Response models: `response_model=ProjectResponse`, status codes: `status_code=status.HTTP_201_CREATED`
- Run tests: `cd backend && python3 -m pytest tests/ -v`
- Test fixtures in `backend/conftest.py`: `test_db` (in-memory SQLite), `test_client` (FastAPI TestClient)
- In-memory SQLite tests require `poolclass=StaticPool` and model imports in conftest.py
- Frontend (ui) uses Vite + React with npm scripts: `npm run dev`, `npm run build`
- React Router: BrowserRouter wraps App in main.jsx, Routes/Route in App.jsx
- Pages go in `ui/src/pages/`, components in `ui/src/components/{feature}/` (e.g., `components/projects/`)
- Use `Link` from react-router-dom for navigation, not `<a>` tags
- API service: `import { get, post, put, del } from '../services/api'` for HTTP calls
- Run frontend tests: `cd ui && npm test`
- Frontend tests in `ui/tests/components/` for component tests, `ui/tests/e2e/` for E2E tests
- Wrap components using react-router-dom with `<BrowserRouter>` in tests
- SQLAlchemy 2.0 typed columns: use `Mapped[T]` and `mapped_column()` for mypy compliance
- Enum columns: `status: Mapped[StatusEnum] = mapped_column(SAEnum(StatusEnum), ...)` (use `from sqlalchemy import Enum as SAEnum`)

---

Started: New PRD & User Stories Generation feature
Previous progress archived to: archive/2026-01-26-meeting-notes-to-requirements-progress.txt

---

## 2026-01-26 - US-002: Create UserStory model with format and status enums
- Created UserStory model with all required fields and enums
- Added StoryFormat (CLASSIC, JOB_STORY), StoryStatus (DRAFT, READY, EXPORTED), StorySize (XS, S, M, L, XL) enums
- Implemented story_id @property for formatted story ID (US-001, US-002, etc.)
- Added user_stories relationship to Project model
- Exported model and enums from models/__init__.py
- Files changed:
  - backend/app/models/user_story.py (created)
  - backend/app/models/project.py (added user_stories relationship)
  - backend/app/models/__init__.py (added exports)
- **Learnings for future iterations:**
  - When adding new models with relationships to other new models (e.g., UserStory -> StoryBatch), defer the relationship definition until the related model exists
  - ForeignKey constraints to non-existent tables should also be deferred
  - Leave TODO comments noting which US will add the missing relationships
  - The story_number field is designed to never be reused - use MAX query with row-level locking when assigning
---

## 2026-01-26 - US-003: Create StoryBatch model for generation tracking
- Created StoryBatch model with all required fields
- Added StoryBatchStatus enum (QUEUED, GENERATING, READY, FAILED, CANCELLED)
- StoryBatch reuses StoryFormat enum from UserStory model
- Added story_batches relationship to Project model
- Updated UserStory model to add ForeignKey to story_batches.id and batch relationship
- Fixed import order in models/__init__.py (user_story before story_batch to avoid circular import)
- Exported StoryBatch and StoryBatchStatus from models/__init__.py
- Files changed:
  - backend/app/models/story_batch.py (created)
  - backend/app/models/project.py (added story_batches relationship)
  - backend/app/models/user_story.py (added ForeignKey and batch relationship)
  - backend/app/models/__init__.py (added exports with correct import order)
- **Learnings for future iterations:**
  - When model A imports from model B, ensure B is imported before A in __init__.py to avoid circular import issues
  - Use ondelete="SET NULL" for optional ForeignKeys when the related record deletion shouldn't cascade
  - StoryBatch -> UserStory relationship uses cascade="all, delete-orphan" so deleting a batch deletes its stories
- **Manual verification needed:** Shell commands unavailable - run `cd backend && python3 -m ruff check .` and `python3 -m pytest tests/ -v` to verify
---

## 2026-01-26 - US-004: Create Alembic migration for new tables
- Created migration `e8a5f2b3c1d0_add_prd_and_user_story_tables.py` for prds, story_batches, and user_stories tables
- Updated `alembic/env.py` to import PRD, UserStory, and StoryBatch models for autogenerate support
- Migration creates tables in correct order: prds, story_batches, then user_stories (due to FK dependency)
- All tables include proper indexes on project_id, status, and other commonly queried columns
- Files changed:
  - backend/alembic/env.py (added PRD, UserStory, StoryBatch imports)
  - backend/alembic/versions/e8a5f2b3c1d0_add_prd_and_user_story_tables.py (created)
- **Learnings for future iterations:**
  - Story_batches must be created before user_stories due to the batch_id ForeignKey
  - Downgrade must drop tables in reverse order (user_stories first, then story_batches, then prds)
  - Use lowercase enum values in migrations to match the str(enum.value) format
  - Add indexes for columns that will be frequently queried (project_id, status, batch_id)
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m alembic upgrade head` to apply migration
  - `cd backend && python3 -m alembic downgrade -1` to test rollback
  - `cd backend && python3 -m alembic upgrade head` to reapply
---

## 2026-01-26 - US-005: Create Pydantic schemas and exception classes
- Created PRD schemas: PRDGenerateRequest, PRDStatusResponse, PRDSection, PRDResponse, PRDSummary, PRDUpdateRequest, ExportFormat
- Created UserStory schemas: StoriesGenerateRequest, StoryBatchStatusResponse, UserStoryResponse, StoryUpdateRequest, ReorderRequest, StoryBatchResponse, StoryExportFormat
- Created PaginatedResponse generic schema using Generic[T] for reuse across API endpoints
- Created exception classes at backend/app/exceptions.py: PRDGenerationError (base), NoRequirementsError, LLMResponseError, GenerationTimeoutError, GenerationCancelledError
- Updated schemas/__init__.py to export all new schemas with organized comments
- Files changed:
  - backend/app/schemas/prd.py (created)
  - backend/app/schemas/user_story.py (created)
  - backend/app/exceptions.py (created)
  - backend/app/schemas/__init__.py (updated with new exports)
- **Learnings for future iterations:**
  - Use `from_attributes=True` model_config for ORM-compatible response schemas
  - Generic[T] requires TypeVar to be defined at module level before class definition
  - Import model enums (PRDMode, PRDStatus, StoryFormat, etc.) from model files to reuse in schemas
  - Exception classes should include relevant context (project_id, raw_response, etc.) for debugging
  - Organize __all__ with comments for better readability when many schemas exist
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m ruff check .` to lint
  - `cd backend && python3 -m pytest tests/ -v` to run tests
  - `git add . && git commit -m "feat: US-005 - Create Pydantic schemas and exception classes"` to commit
---

## 2026-01-26 - US-006: Create PRD generation prompt templates
- Created draft mode prompt at backend/prompts/generate_prd_draft_v1.txt
- Created detailed mode prompt at backend/prompts/generate_prd_detailed_v1.txt
- Draft prompt has 7 sections: executive_summary, problem_statement, goals_and_objectives, proposed_solution, open_questions, identified_gaps, next_steps
- Draft prompt emphasizes gaps, open questions, and areas needing clarification (sections 5 & 6 marked as CRITICAL)
- Detailed prompt has 12 sections covering all PRD aspects: executive_summary, problem_statement, goals_and_objectives, target_users, proposed_solution, functional_requirements, non_functional_requirements, technical_considerations, success_metrics, timeline_and_milestones, risks_and_mitigations, appendix
- Both prompts specify JSON output format with title and sections array
- Both prompts include {requirements_by_section} placeholder for dynamic content
- Files changed:
  - backend/prompts/generate_prd_draft_v1.txt (created)
  - backend/prompts/generate_prd_detailed_v1.txt (created)
- **Learnings for future iterations:**
  - Prompt templates live in backend/prompts/ with naming convention: {action}_{target}_{version}.txt
  - LLM prompts should specify output format precisely including field names and structure
  - For draft/exploratory modes, mark critical sections that need emphasis
  - Always include IMPORTANT INSTRUCTIONS section for consistent LLM behavior
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m ruff check .` to lint
  - `cd backend && python3 -m pytest tests/ -v` to run tests
  - `git add . && git commit -m "feat: US-006 - Create PRD generation prompt templates"` to commit
---

## 2026-01-26 - US-007: Implement PRDGenerator service with background tasks
- Created PRDGenerator service class at backend/app/services/prd_generator.py
- Implemented generate() method that loads requirements, builds prompt, calls LLM, and parses response
- Implemented _get_next_version() with row-level locking using with_for_update() to prevent race conditions
- Implemented _build_prompt() that loads appropriate template (draft/detailed) based on mode
- Implemented _parse_response() that extracts title, sections from JSON and generates raw_markdown
- Added _load_requirements() to fetch active requirements grouped by section
- Added _format_requirements() to format requirements for prompt injection
- Added _generate_markdown() to convert PRD sections to markdown format
- Created generate_prd_task() background task function with proper status transitions:
  - Sets status to GENERATING before starting
  - Checks for CANCELLED status before LLM call
  - Checks for CANCELLED status after LLM call (prevents saving stale results)
  - Sets status to READY on success, FAILED on error
- Raises NoRequirementsError when project has no active requirements
- Raises LLMResponseError on malformed/invalid JSON from LLM
- Defined LLM config constants (PRD_LLM_TIMEOUT=120, PRD_LLM_TEMPERATURE=0.7, PRD_LLM_MAX_TOKENS=8000)
- Exported PRDGenerator and generate_prd_task from services/__init__.py
- Files changed:
  - backend/app/services/prd_generator.py (created)
  - backend/app/services/__init__.py (added exports)
- **Learnings for future iterations:**
  - Use with_for_update() on a parent record (Project) to serialize version assignment
  - Background tasks should refresh the db object before checking cancelled status
  - Parse response should handle markdown code block wrappers from LLM
  - LLM config constants are defined at module level but providers need enhancement to use them
  - Format requirements with display-friendly section names for better LLM context
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m ruff check app/services/prd_generator.py` to lint
  - `cd backend && python3 -m pytest tests/ -v` to run tests
---

## 2026-01-26 - US-008: Create PRD router with all endpoints
- Created PRD router at backend/app/routers/prds.py with all required endpoints:
  - POST /projects/{project_id}/prds/generate - starts PRD generation, returns status=queued
  - GET /prds/{prd_id}/status - returns current generation status for polling
  - POST /prds/{prd_id}/cancel - cancels generation if queued or generating
  - GET /projects/{project_id}/prds - lists PRDs with pagination, skip/limit, include_archived filter
  - GET /prds/{prd_id} - returns single PRD with all sections
  - PUT /prds/{prd_id} - updates PRD title and/or sections, regenerates raw_markdown
  - DELETE /prds/{prd_id} - soft deletes PRD (sets deleted_at)
  - POST /prds/{prd_id}/archive - sets status to archived
  - GET /prds/{prd_id}/export - exports PRD in markdown or JSON format with Content-Disposition header
- Background task uses a fresh SessionLocal() session since request session closes before task runs
- All endpoints enforce project access via _get_project_or_404 helper
- Soft delete excludes PRDs from all queries via deleted_at.is_(None) filter
- Exported prds_router from routers/__init__.py
- Files changed:
  - backend/app/routers/prds.py (created)
  - backend/app/routers/__init__.py (added prds_router export)
- **Learnings for future iterations:**
  - Background tasks run AFTER the request completes, so they need their own database session
  - Use SessionLocal() directly in the background task wrapper, not the Depends(get_db) session
  - Soft delete pattern: set deleted_at timestamp, filter deleted_at.is_(None) in all queries
  - Export endpoints use Response with media_type and Content-Disposition for file downloads
  - Always validate status transitions (e.g., only cancel QUEUED/GENERATING, only archive READY)
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m ruff check app/routers/prds.py` to lint
  - `cd backend && python3 -m pytest tests/ -v` to run tests
  - `git add . && git commit -m "feat: US-008 - Create PRD router with all endpoints"` to commit
---

## 2026-01-26 - US-009: Register PRD router in main.py
- Imported prds_router in backend/app/main.py from app.routers
- Added app.include_router(prds_router) to register the PRD endpoints
- PRD router has tags=["prds"] which will show in OpenAPI docs under 'prds' tag
- Files changed:
  - backend/app/main.py (added prds_router import and registration)
- **Learnings for future iterations:**
  - Router registration follows simple pattern: import from routers/__init__.py, call app.include_router()
  - Keep router imports alphabetically sorted for consistency
  - Each router should have tags=["feature_name"] for OpenAPI grouping
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m ruff check app/main.py` to lint
  - `cd backend && python3 -m pytest tests/ -v` to run tests
  - Start the server and visit /docs to confirm PRD endpoints appear under 'prds' tag
  - `git add . && git commit -m "feat: US-009 - Register PRD router in main.py"` to commit
---

## 2026-01-26 - US-010: Create PRDLandingPage with project selection
- Created PRDLandingPage component at ui/src/pages/PRDLandingPage.jsx
- Page displays feature title, description, and explains Draft vs Detailed modes
- Project selector dropdown fetches and shows all available projects
- Selecting a project navigates to /app/projects/{projectId}/prd
- Added loading spinner while fetching projects
- Added error state with retry button
- Added empty state with link to create projects
- Added all PRD API service functions to ui/src/services/api.js:
  - generatePRD(projectId, options) - starts PRD generation
  - getPRDStatus(prdId) - polls generation status
  - cancelPRDGeneration(prdId) - cancels queued/generating PRD
  - getPRD(prdId) - fetches single PRD with sections
  - updatePRD(prdId, data) - updates PRD title/sections
  - listPRDs(projectId, options) - lists PRDs with pagination
  - deletePRD(prdId) - soft deletes PRD
  - exportPRD(prdId, format) - exports PRD as blob for download
- Files changed:
  - ui/src/pages/PRDLandingPage.jsx (created)
  - ui/src/pages/PRDLandingPage.css (created)
  - ui/src/services/api.js (added PRD API functions)
- **Learnings for future iterations:**
  - Landing pages follow pattern: header with icon, description, feature cards, then action area
  - Use useNavigate() hook to programmatically navigate on selection
  - Export API functions return Blob for file downloads (use response.blob() instead of response.json())
  - Group API functions by feature with comment sections for organization
  - Project dropdown pattern: fetch on mount, handle loading/error/empty states
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd ui && npm run build` to verify no build errors
  - Start the app and navigate to /app/prd to verify the page loads
  - `git add . && git commit -m "feat: US-010 - Create PRDLandingPage with project selection"` to commit
---

## 2026-01-26 - US-011: Create PRDGeneratorPage with options and polling
- Created PRDGeneratorPage component at ui/src/pages/PRDGeneratorPage.jsx
- Mode selector shows Draft and Detailed options with icons and descriptions
- Generate button starts generation, calls generatePRD API, shows loading state
- 30-second cooldown timer (COOLDOWN_DURATION_MS = 30000) prevents rapid re-generation
- Progress overlay displays during generation with spinner and cancel button
- Status polling every 2 seconds (POLL_INTERVAL_MS = 2000) using setInterval
- On ready status: stops polling and navigates to /app/prds/{prdId}
- On failed status: stops polling, shows error message with retry button
- On cancelled status: stops polling and clears loading state
- Created matching CSS file at ui/src/pages/PRDGeneratorPage.css
- Uses useParams hook to get projectId, useNavigate for routing
- Uses useRef for cleanup of polling and cooldown intervals
- Uses useCallback for startPolling to avoid stale closures
- Files changed:
  - ui/src/pages/PRDGeneratorPage.jsx (created)
  - ui/src/pages/PRDGeneratorPage.css (created)
- **Learnings for future iterations:**
  - Use useRef for interval IDs to ensure proper cleanup on unmount
  - Polling should check terminal states (ready/failed/cancelled) and clear interval
  - Cooldown timer uses separate state (cooldownUntil timestamp) and interval for countdown display
  - Progress overlay uses fixed positioning with z-index for modal effect
  - Mode selector is a clickable button group with selected state indicator
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd ui && npm run build` to verify no build errors
  - Note: Route is not yet registered (US-015 will add to App.jsx)
  - `git add . && git commit -m "feat: US-011 - Create PRDGeneratorPage with options and polling"` to commit
---

## 2026-01-26 - US-012: Create PRDEditorPage with section editor
- Created PRDEditorPage component at ui/src/pages/PRDEditorPage.jsx
- Page fetches PRD by ID using useParams hook and getPRD API function
- Table of contents sidebar with section navigation (scrollToSection with smooth scrolling)
- Each section is collapsible with expand/collapse toggle using Set state
- Markdown editor uses textarea for each section with placeholder text
- Auto-save with 1 second debounce (DEBOUNCE_DELAY_MS = 1000) using setTimeout in debouncedSave
- Save indicator shows four states: saved (green checkmark), saving (spinning), unsaved (yellow), error (red X)
- Native beforeunload event listener warns user when leaving with unsaved changes
- Collapse/expand all button in sidebar header toggles all sections at once
- PRD title is editable with auto-save
- Version badge and mode badge displayed in header
- Created comprehensive CSS at ui/src/pages/PRDEditorPage.css with responsive layout
- Sidebar uses sticky positioning with fixed height for scrolling
- Grid layout with 280px sidebar and flexible main content area
- Files changed:
  - ui/src/pages/PRDEditorPage.jsx (created)
  - ui/src/pages/PRDEditorPage.css (created)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Use native window.addEventListener('beforeunload', ...) for browser leave warning (more compatible than React Router hooks)
  - Use useRef for sectionRefs to enable scroll-to-section functionality
  - Debounced save pattern: useCallback for saveChanges, then wrap in setTimeout in debouncedSave
  - Use Set for tracking multiple expanded/collapsed states (efficient add/delete operations)
  - formatSectionTitle helper converts snake_case to Title Case for display
  - Grid layout with sticky sidebar is better than flexbox for editor pages
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd ui && npm run build` to verify no build errors
  - Note: Route is not yet registered (US-015 will add to App.jsx)
  - `git add . && git commit -m "feat: US-012 - Create PRDEditorPage with section editor"` to commit
---

## 2026-01-26 - US-013: Create PRDExportModal and PRDVersionSelector
- Created PRDExportModal component at ui/src/components/prd/PRDExportModal.jsx
  - Shows format options: Markdown and JSON with icons and descriptions
  - Handles export via exportPRD API function
  - Triggers file download with sanitized filename from PRD title
  - Shows loading spinner and error states
- Created PRDVersionSelector component at ui/src/components/prd/PRDVersionSelector.jsx
  - Dropdown that fetches all PRD versions from listPRDs API on open
  - Shows version number, mode, and creation date for each version
  - Current version highlighted with "Current" badge and checkmark
  - Selecting a version navigates to /app/prds/{prdId}
  - Handles click-outside to close, Escape key, loading/error states
- Updated PRDEditorPage.jsx to integrate both components:
  - Replaced static version badge with PRDVersionSelector
  - Added Export button in header that opens PRDExportModal
  - Added showExportModal state for modal visibility
- Created matching CSS files with consistent styling
- Updated PRDEditorPage.css with header actions styles
- Files changed:
  - ui/src/components/prd/PRDExportModal.jsx (created)
  - ui/src/components/prd/PRDExportModal.css (created)
  - ui/src/components/prd/PRDVersionSelector.jsx (created)
  - ui/src/components/prd/PRDVersionSelector.css (created)
  - ui/src/pages/PRDEditorPage.jsx (updated with new components)
  - ui/src/pages/PRDEditorPage.css (added header actions styles)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Create component-specific folders under ui/src/components/{feature}/ (e.g., prd/) for feature-specific components
  - Use the existing Modal component wrapper from common/ for consistent modal behavior
  - File download pattern: fetch as blob, create object URL, create and click an anchor element, then revoke URL
  - Dropdown pattern: useRef for click-outside detection, fetch data on open (lazy load)
  - Use aria-pressed for toggle buttons, aria-haspopup and aria-expanded for dropdown triggers
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd ui && npm run build` to verify no build errors
  - `git add . && git commit -m "feat: US-013 - Create PRDExportModal and PRDVersionSelector"` to commit
---

## 2026-01-26 - US-014: Update LandingPage to enable PRD card
- Updated PRD feature card in LandingPage.jsx to be enabled
- Changed title from 'Generate PRD (v0)' to 'Generate PRD'
- Added link to '/app/prd' (was previously null/disabled)
- Card now renders as a Link component instead of a disabled div
- Files changed:
  - ui/src/pages/LandingPage.jsx (updated features array)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Feature cards in LandingPage use `link: null` for disabled and `link: '/path'` for enabled
  - The FeatureCard component automatically renders as Link when link is truthy
  - Simple pattern: enable a feature card by just adding the link path
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd ui && npm run build` to verify no build errors
  - Navigate to the landing page and verify the PRD card is clickable and links to /app/prd
  - `git add . && git commit -m "feat: US-014 - Update LandingPage to enable PRD card"` to commit
---

## 2026-01-26 - US-015: Add PRD routes to App.jsx
- Added imports for PRDLandingPage, PRDGeneratorPage, and PRDEditorPage in App.jsx
- Added route /app/prd → PRDLandingPage
- Added route /app/projects/:projectId/prd → PRDGeneratorPage
- Added route /app/prds/:prdId → PRDEditorPage
- Routes are placed before the catch-all /app/* route to ensure proper matching
- All routes are within the /app section protected by the existing app structure
- Files changed:
  - ui/src/App.jsx (added imports and routes)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Keep routes ordered with specific routes before wildcard catch-all routes
  - Use consistent param naming: :projectId for project context, :prdId for resource-specific
  - PRD routes follow pattern: landing (/app/prd), generator (/app/projects/:projectId/prd), editor (/app/prds/:prdId)
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd ui && npm run build` to verify no build errors
  - Start the app and navigate to /app/prd, /app/projects/[id]/prd, and /app/prds/[id] to verify routes work
  - `git add . && git commit -m "feat: US-015 - Add PRD routes to App.jsx"` to commit
---

## 2026-01-26 - US-016: Create story generation prompt templates
- Created classic format prompt at backend/prompts/generate_stories_classic_v1.txt
- Created job story format prompt at backend/prompts/generate_stories_job_v1.txt
- Classic prompt uses "As a [user], I want [goal], so that [benefit]" format
- Job story prompt uses "When [situation], I want to [action], so I can [outcome]" format
- Both prompts specify JSON output with stories array containing: title, description, acceptance_criteria, suggested_size, suggested_labels, source_requirement_ids
- Both prompts include {requirements_by_section} placeholder for dynamic requirement injection
- Prompts include INVEST principles guidance and story sizing recommendations (XS through XL)
- Prompts include examples and detailed field descriptions for LLM clarity
- Files changed:
  - backend/prompts/generate_stories_classic_v1.txt (created)
  - backend/prompts/generate_stories_job_v1.txt (created)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Story prompts live in backend/prompts/ (same location as PRD prompts)
  - Job stories focus on context/situation rather than user personas
  - Story prompt JSON output includes source_requirement_ids for traceability back to original requirements
  - Include clear examples in prompts to guide LLM behavior
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m ruff check .` to lint
  - `cd backend && python3 -m pytest tests/ -v` to run tests
  - `git add . && git commit -m "feat: US-016 - Create story generation prompt templates"` to commit
---

## 2026-01-26 - US-017: Implement StoriesGenerator service with background tasks
- Created StoriesGenerator service class at backend/app/services/stories_generator.py
- Implemented generate() method that loads requirements, builds prompt, calls LLM, creates UserStory records
- Implemented _get_next_story_number() with row-level locking (with_for_update() on Project) to prevent race conditions
- Story numbers are never reused - queries MAX(story_number) including deleted stories
- Implemented _load_requirements() with optional section_filter parameter
- Implemented _build_prompt() that loads appropriate template (classic/job story) based on format
- Implemented _parse_response() that extracts stories array from JSON and validates structure
- Added _map_size() helper to convert size strings to StorySize enum
- Created generate_stories_task() background task function with proper status transitions:
  - Sets batch status to GENERATING before starting
  - Checks for CANCELLED status before LLM call
  - Checks for CANCELLED status after LLM call (prevents saving stale results)
  - Sets batch status to READY on success, FAILED on error
  - Updates batch.story_count after all stories are created
- LLM config constants defined: STORIES_LLM_TIMEOUT=90, STORIES_LLM_TEMPERATURE=0.5, STORIES_LLM_MAX_TOKENS=4000
- Exported StoriesGenerator and generate_stories_task from services/__init__.py
- Files changed:
  - backend/app/services/stories_generator.py (created)
  - backend/app/services/__init__.py (added exports)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - StoriesGenerator follows same patterns as PRDGenerator for consistency
  - Use with_for_update() on Project row to serialize story_number assignment across concurrent generations
  - Requirements in _load_requirements() include the id field for traceability (source_requirement_ids in output)
  - Background task duplicates some generator logic to support cancellation checks between operations
  - Story numbers continue from MAX even for deleted stories - ensures US-XXX IDs are never reused
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m ruff check app/services/stories_generator.py` to lint
  - `cd backend && python3 -m pytest tests/ -v` to run tests
  - `git add . && git commit -m "feat: US-017 - Implement StoriesGenerator service with background tasks"` to commit
---

## 2026-01-26 - US-018: Create stories router with all endpoints
- Created Stories router at backend/app/routers/stories.py with all required endpoints:
  - POST /projects/{project_id}/stories/generate - starts story generation, returns batch with status=queued
  - GET /stories/batches/{batch_id}/status - returns current batch generation status for polling
  - POST /stories/batches/{batch_id}/cancel - cancels generation if queued or generating
  - GET /projects/{project_id}/stories/batches - lists all story generation batches
  - GET /projects/{project_id}/stories - lists stories with pagination, batch_id, status, and labels filters
  - GET /stories/{story_id} - returns single story with all details
  - PUT /stories/{story_id} - updates story title, description, acceptance_criteria, labels, size, status
  - DELETE /stories/{story_id} - soft deletes story (sets deleted_at)
  - POST /projects/{project_id}/stories/reorder - updates story order based on provided story_ids array
  - DELETE /projects/{project_id}/stories/batch/{batch_id} - soft deletes all stories in batch and deletes batch record
  - GET /projects/{project_id}/stories/export - exports stories in markdown, CSV, or JSON format
- Background task uses a fresh SessionLocal() session since request session closes before task runs
- All endpoints enforce project access via _get_project_or_404 helper
- Soft delete excludes stories from all queries via deleted_at.is_(None) filter
- CSV export uses pipe-separated acceptance criteria as specified
- Labels filtering uses LIKE pattern matching on JSON string for database portability
- Exported stories_router from routers/__init__.py
- Files changed:
  - backend/app/routers/stories.py (created)
  - backend/app/routers/__init__.py (added stories_router export)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Stories router follows same patterns as PRD router for consistency
  - Reorder endpoint accepts array of story_ids and sets order field based on position
  - Labels filter uses LIKE pattern on JSON string (e.g., `%"label"%`) for cross-database compatibility
  - Batch deletion soft-deletes stories but hard-deletes the batch record itself
  - Export endpoint supports optional batch_id filter to export specific batch only
  - CSV export format: Story ID, Title, Description, Acceptance Criteria (pipe-separated), Size, Labels (comma-separated), Status, Format
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m ruff check app/routers/stories.py` to lint
  - `cd backend && python3 -m pytest tests/ -v` to run tests
  - `git add . && git commit -m "feat: US-018 - Create stories router with all endpoints"` to commit
---

## 2026-01-26 - US-019: Register stories router in main.py
- Imported stories_router in backend/app/main.py from app.routers
- Added app.include_router(stories_router) to register the stories endpoints
- Stories router has tags=["stories"] which will show in OpenAPI docs under 'stories' tag
- Files changed:
  - backend/app/main.py (added stories_router import and registration)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Router registration follows simple pattern: import from routers/__init__.py, call app.include_router()
  - Keep router imports alphabetically sorted for consistency (stories after requirements)
  - This follows the exact same pattern as US-009 for PRD router registration
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m ruff check app/main.py` to lint
  - `cd backend && python3 -m pytest tests/ -v` to run tests
  - Start the server and visit /docs to confirm stories endpoints appear under 'stories' tag
  - `git add . && git commit -m "feat: US-019 - Register stories router in main.py"` to commit
---

## 2026-01-26 - US-020: Create StoriesLandingPage with project selection
- Created StoriesLandingPage component at ui/src/pages/StoriesLandingPage.jsx
- Page displays feature title ("User Story Generator"), description, and explains Classic vs Job Story formats
- Project selector dropdown fetches and shows all available projects
- Selecting a project navigates to /app/projects/{projectId}/stories
- Added loading spinner while fetching projects
- Added error state with retry button
- Added empty state with link to create projects
- Added info banner explaining that stories are added incrementally (don't replace existing)
- Created matching CSS file at ui/src/pages/StoriesLandingPage.css with blue theme (vs PRD's orange)
- Added all Stories API service functions to ui/src/services/api.js:
  - generateStories(projectId, options) - starts story generation
  - getBatchStatus(batchId) - polls batch generation status
  - cancelStoryGeneration(batchId) - cancels queued/generating batch
  - listStories(projectId, options) - lists stories with pagination and filters
  - getStory(storyId) - fetches single story
  - updateStory(storyId, data) - updates story details
  - deleteStory(storyId) - soft deletes story
  - listBatches(projectId) - lists all generation batches
  - deleteBatch(projectId, batchId) - deletes all stories in batch
  - reorderStories(projectId, storyIds) - updates story order
  - exportStories(projectId, format, batchId) - exports stories as blob
- Files changed:
  - ui/src/pages/StoriesLandingPage.jsx (created)
  - ui/src/pages/StoriesLandingPage.css (created)
  - ui/src/services/api.js (added Stories API functions)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Stories landing page follows PRD landing page patterns but uses blue color scheme
  - Info banner is useful for behaviors that differ from expectations (stories append vs replace)
  - API functions for Stories follow same patterns as PRD functions
  - exportStories takes optional batchId for filtering export to specific batch
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd ui && npm run build` to verify no build errors
  - Note: Route is not yet registered (US-027 will add to App.jsx)
  - `git add . && git commit -m "feat: US-020 - Create StoriesLandingPage with project selection"` to commit
---

## 2026-01-26 - US-021: Create UserStoriesPage with options panel
- Created UserStoriesPage component at ui/src/pages/UserStoriesPage.jsx
- Format selector shows Classic and Job Story options with icons and descriptions
- Optional section filter multi-select dropdown for requirement sections (all 9 sections available)
- Section filter uses click-outside detection and checkbox-based selection
- Generate button starts generation, calls generateStories API, shows loading state
- 30-second cooldown timer (COOLDOWN_DURATION_MS = 30000) prevents rapid re-generation
- Progress overlay displays during generation with spinner and cancel button
- Status polling every 2 seconds (POLL_INTERVAL_MS = 2000) using setInterval
- On ready status: stops polling and refreshes stories list
- On failed status: stops polling, shows error message with retry button
- On cancelled status: stops polling and clears loading state
- Info dialog warns that regeneration adds stories (doesn't replace existing)
- Shows existing stories list at bottom with story ID badge, title, and size indicator
- Created comprehensive CSS at ui/src/pages/UserStoriesPage.css with blue theme
- Files changed:
  - ui/src/pages/UserStoriesPage.jsx (created)
  - ui/src/pages/UserStoriesPage.css (created)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Stories page uses blue color scheme (#3B82F6) vs PRD's teal (#4ECDC4)
  - Info dialog pattern: show warning before destructive/additive actions
  - Section filter uses checkbox multi-select in a dropdown - cleaner than inline checkboxes
  - Existing stories list shows abbreviated info to avoid overwhelming the generation UI
  - Unlike PRD which navigates to editor on completion, stories just refreshes the list on same page
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd ui && npm run build` to verify no build errors
  - Note: Route is not yet registered (US-027 will add to App.jsx)
  - `git add . && git commit -m "feat: US-021 - Create UserStoriesPage with options panel"` to commit
---

## 2026-01-26 - US-022: Create StoryCard component with expand/collapse
- Created StoryCard component at ui/src/components/stories/StoryCard.jsx
- Created stories component folder at ui/src/components/stories/
- Collapsed view shows story ID badge (US-001 style), title, size indicator, and label chips (max 3 visible with +N indicator)
- Expanded view shows:
  - Status and format badges
  - Full description section
  - Acceptance criteria as checklist with checkmark icons
  - All labels expanded
  - Edit and Delete action buttons
- Click on header to expand/collapse (entire header is clickable)
- Delete button shows confirmation modal using existing Modal component
- Delete modal includes story ID, title, and warning message
- Integrated StoryCard into UserStoriesPage, replacing inline story rendering
- Added handleEditStory and handleDeleteStory handlers in UserStoriesPage
- Edit handler logs to console (will be connected to StoryEditModal in US-023)
- Delete handler calls deleteStory API and refreshes the stories list
- Updated .stories-existing-items CSS to work better with expanded StoryCard
- Created comprehensive CSS with size-based color coding (XS=blue, S=green, M=yellow, L=orange, XL=red)
- Files changed:
  - ui/src/components/stories/StoryCard.jsx (created)
  - ui/src/components/stories/StoryCard.css (created)
  - ui/src/pages/UserStoriesPage.jsx (updated imports, added handlers, integrated StoryCard)
  - ui/src/pages/UserStoriesPage.css (updated stories-existing-items container)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Create feature-specific component folders under ui/src/components/{feature}/ (e.g., stories/)
  - StoryCard follows patterns from ConflictCard for expand/collapse behavior
  - Use the existing Modal component for confirmation dialogs instead of inline modals
  - Story ID badge uses same blue color (#3B82F6) as the Stories feature theme
  - Labels in collapsed view show max 3 with a +N indicator for overflow
  - Size colors follow a cold-to-hot gradient (XS=blue to XL=red) for visual effort indication
  - Delete handler should refresh the list after successful deletion
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd ui && npm run build` to verify no build errors
  - Navigate to /app/projects/{id}/stories with existing stories to verify StoryCard rendering
  - Test expand/collapse, edit button, and delete with confirmation
  - `git add . && git commit -m "feat: US-022 - Create StoryCard component with expand/collapse"` to commit
---

## 2026-01-26 - US-023: Create StoryEditModal with all fields
- Created StoryEditModal component at ui/src/components/stories/StoryEditModal.jsx
- Title field is editable with required validation
- Description field uses multiline textarea with 4 rows
- Acceptance criteria list with full functionality:
  - Add new criterion with auto-focus on new item
  - Remove criterion with X button
  - Reorder via up/down arrow buttons
  - Drag and drop reorder using native HTML5 drag events (no external library needed)
  - Visual feedback during drag with opacity change
- Size selector dropdown with all options (XS, S, M, L, XL) and size hint text
- Labels management:
  - Display existing labels as removable chips
  - Add new labels via text input + Enter key or Add button
  - Duplicate label prevention
- Status selector dropdown (Draft, Ready, Exported)
- Save and Cancel buttons with:
  - Save disabled when title is empty or during save
  - Saving spinner and "Saving..." text during API call
  - Ctrl+S keyboard shortcut support
- Unsaved changes warning modal:
  - Shown when closing with unsaved changes
  - "Continue Editing" to stay, "Discard Changes" to exit
  - Uses separate Modal component instance
- Updated UserStoriesPage.jsx to integrate StoryEditModal:
  - Added editingStory and isSavingStory state
  - handleEditStory opens modal with story data
  - handleSaveStory calls updateStory API and refreshes list on success
  - handleCloseEditModal clears editing state
- Created comprehensive CSS with responsive design
- Files changed:
  - ui/src/components/stories/StoryEditModal.jsx (created)
  - ui/src/components/stories/StoryEditModal.css (created)
  - ui/src/pages/UserStoriesPage.jsx (added modal integration)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Native HTML5 drag and drop works well for simple list reordering without needing external libraries
  - Use separate Modal instances for nested modals (e.g., unsaved changes warning inside edit modal)
  - hasChanges() function with JSON.stringify comparison works for detecting form changes with arrays
  - Ctrl+S keyboard shortcut can be added with useEffect and document.addEventListener
  - Acceptance criteria uses index-based key which is acceptable since reordering updates the whole array
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd ui && npm run build` to verify no build errors
  - Navigate to /app/projects/{id}/stories, click Edit on a story card
  - Test all fields: title, description, acceptance criteria (add/remove/reorder), size, labels, status
  - Test unsaved changes warning by making changes then clicking Cancel
  - `git add . && git commit -m "feat: US-023 - Create StoryEditModal with all fields"` to commit
---

## 2026-01-26 - US-024: Create StoriesExportModal with format options
- Created StoriesExportModal component at ui/src/components/stories/StoriesExportModal.jsx
- Format selector shows three options: Markdown, CSV, and JSON with icons and descriptions
- Optional batch filter dropdown that fetches batches on mount via listBatches API
  - Shows "All stories" as default option
  - Each batch option shows creation date, story count, and format
- Download button triggers file download with proper blob handling
- Filename uses sanitized project name with format extension (e.g., `project-name-stories.md`, `project-name-batch-stories.csv`)
- Integrated into UserStoriesPage with Export button next to "Existing Stories" header
- Created comprehensive CSS with consistent styling matching the Stories feature blue theme
- Files changed:
  - ui/src/components/stories/StoriesExportModal.jsx (created)
  - ui/src/components/stories/StoriesExportModal.css (created)
  - ui/src/pages/UserStoriesPage.jsx (added import, state, Export button, and modal render)
  - ui/src/pages/UserStoriesPage.css (added .stories-existing-header and .stories-export-btn styles)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Export modals should fetch filter options (like batches) on mount for lazy loading
  - Batch filter select shows formatted date + story count + format for easy identification
  - Follow PRDExportModal patterns for consistency: format selector buttons, download blob handling, error states
  - Export button placement: add to the header of the list section being exported
  - Use flexbox with justify-content: space-between for header with title and action button
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd ui && npm run build` to verify no build errors
  - Navigate to /app/projects/{id}/stories with existing stories
  - Click Export button next to "Existing Stories" header
  - Test format selection, batch filter dropdown, and download functionality
  - `git add . && git commit -m "feat: US-024 - Create StoriesExportModal with format options"` to commit
---

## 2026-01-26 - US-025: Create StoryBatchFilter for batch management
- Created StoryBatchFilter component at ui/src/components/stories/StoryBatchFilter.jsx
- Component displays dropdown with "All stories" option and each batch showing:
  - Creation date (formatted)
  - Story count with proper singular/plural
  - Story format (Classic or Job Story)
- Selecting a batch filters the stories list via filterBatchId state in UserStoriesPage
- Delete batch option for each batch:
  - Trash icon button appears on hover for each batch option
  - Opens confirmation modal using existing Modal component
  - Shows warning icon, number of stories that will be deleted, batch details, and "cannot be undone" note
  - Delete button shows "Delete X Stories" with spinner during deletion
  - On success: closes modal, refreshes batches, resets filter if deleted batch was selected, notifies parent
  - On error: shows error message in modal, allows retry
- Click-outside and Escape key support for closing dropdown
- Integrated into UserStoriesPage:
  - Added filterBatchId state
  - fetchStories now passes batch_id filter when filterBatchId is set
  - useEffect triggers fetchStories when filterBatchId changes
  - Header shows "Filtered Stories" vs "Existing Stories" based on filter state
  - Export button disabled when no stories
  - Empty state message changes based on whether filter is active
- Added CSS styles for batch filter wrapper and empty state
- Files changed:
  - ui/src/components/stories/StoryBatchFilter.jsx (created)
  - ui/src/components/stories/StoryBatchFilter.css (created)
  - ui/src/pages/UserStoriesPage.jsx (added import, state, handlers, component integration)
  - ui/src/pages/UserStoriesPage.css (added batch filter wrapper and empty state styles)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - StoryBatchFilter follows patterns from StoriesExportModal for batch loading and formatting
  - Delete confirmation modals should include specific counts to help users understand impact
  - When filtering by a related entity (batch), reset filter if that entity is deleted
  - Use separate button element inside option for the delete action to prevent click event conflicts
  - listStories API accepts batch_id filter via query params
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd ui && npm run build` to verify no build errors
  - Navigate to /app/projects/{id}/stories
  - Test batch filter dropdown (shows batches with date, count, format)
  - Test filtering by selecting a batch (stories list updates)
  - Test batch deletion (confirmation shows count, deletes all stories in batch)
  - `git add . && git commit -m "feat: US-025 - Create StoryBatchFilter for batch management"` to commit
---

## 2026-01-26 - US-026: Update LandingPage to enable Stories card
- Updated feature card id=3 in LandingPage.jsx to be the User Stories card
- Changed title from 'Generate Epics & Jira Tickets' to 'User Stories'
- Changed description to 'Generate actionable user stories from your requirements'
- Updated input/output descriptions to match story generation flow
- Changed color scheme to blue (#E3F2FD, #1E88E5) to match Stories feature theme
- Set link to '/app/stories' to enable the card
- Card now renders as a Link component and is clickable
- Files changed:
  - ui/src/pages/LandingPage.jsx (updated features array)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Feature cards in LandingPage use `link: null` for disabled and `link: '/path'` for enabled
  - The FeatureCard component automatically renders as Link when link is truthy
  - Match color scheme to the feature's theme (Stories = blue #1E88E5)
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd ui && npm run build` to verify no build errors
  - Navigate to the landing page and verify the User Stories card is clickable and links to /app/stories
  - `git add . && git commit -m "feat: US-026 - Update LandingPage to enable Stories card"` to commit
---

## 2026-01-26 - US-027: Add stories routes to App.jsx
- Added imports for StoriesLandingPage and UserStoriesPage in App.jsx
- Added route /app/stories → StoriesLandingPage
- Added route /app/projects/:projectId/stories → UserStoriesPage
- Routes are placed before the catch-all /app/* route to ensure proper matching
- All routes are within the /app section protected by the existing app structure
- Files changed:
  - ui/src/App.jsx (added imports and routes)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Stories routes follow the same pattern as PRD routes (landing → project-specific page)
  - Use consistent param naming: :projectId for project context
  - Routes pattern: landing (/app/stories), generator (/app/projects/:projectId/stories)
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd ui && npm run build` to verify no build errors
  - Start the app and navigate to /app/stories and /app/projects/[id]/stories to verify routes work
  - `git add . && git commit -m "feat: US-027 - Add stories routes to App.jsx"` to commit
---

## 2026-01-26 - US-028: Backend unit tests for PRD service
- Created comprehensive test file at backend/tests/test_prd_service.py
- Added 25+ test functions covering all acceptance criteria:
  - test_generate_prd_draft_mode: Verifies draft mode generates 7 sections with proper structure
  - test_generate_prd_draft_mode_includes_gaps_and_questions: Verifies open_questions, identified_gaps, next_steps sections
  - test_generate_prd_detailed_mode: Verifies detailed mode generates all 12 sections
  - test_version_auto_increment: Verifies versions increment correctly for same project
  - test_version_independent_across_projects: Verifies versions are project-specific
  - test_version_increment_with_concurrency: Verifies row lock logic (note: FOR UPDATE is no-op in SQLite)
  - test_get_next_version_starts_at_one: Verifies first version is 1
  - test_no_requirements_raises_error: Verifies NoRequirementsError for empty project
  - test_no_active_requirements_raises_error: Verifies inactive requirements don't count
  - test_malformed_llm_response_*: Multiple tests for various malformed responses (invalid JSON, missing title, empty sections, missing fields, non-object)
  - test_llm_response_with_markdown_code_blocks: Verifies markdown wrapper stripping
  - test_generate_prd_task_*: Tests for background task success, cancellation, failure handling
  - test_load_requirements_*: Tests for requirement loading and grouping
  - test_format_requirements_output: Tests markdown formatting
  - test_generate_markdown_output: Tests markdown generation
- Updated conftest.py to import PRD, UserStory, StoryBatch models for test database setup
- MockLLMProvider and FailingLLMProvider classes for consistent mocking
- Helper functions for creating test projects, requirements, and PRDs
- Files changed:
  - backend/tests/test_prd_service.py (created)
  - backend/conftest.py (added PRD, UserStory, StoryBatch imports)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Use MockLLMProvider class pattern for consistent LLM mocking across tests
  - Helper functions (_create_test_project, _create_test_requirement, etc.) reduce test boilerplate
  - Test both the generate() method and generate_prd_task() background task separately
  - SQLite's FOR UPDATE is a no-op - concurrency tests verify logic but true locking needs PostgreSQL
  - Test malformed LLM responses separately: invalid JSON, missing fields, wrong structure
  - Always test edge cases: no requirements, inactive requirements, cancelled status
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m ruff check tests/test_prd_service.py` to lint
  - `cd backend && python3 -m pytest tests/test_prd_service.py -v` to run tests
  - `git add . && git commit -m "feat: US-028 - Backend unit tests for PRD service"` to commit
---

## 2026-01-26 - US-029: Backend integration tests for PRD endpoints
- Created comprehensive integration test file at backend/tests/test_prd_api.py
- Implemented 35+ test functions covering all acceptance criteria:
  - test_generate_returns_queued_status: Verifies POST /generate returns status=queued and 202 status code
  - test_generate_returns_404_for_missing_project: Verifies 404 for non-existent project
  - test_generate_validates_mode: Verifies mode field validation
  - test_status_polling_*: Multiple tests for GET /status (queued, generating, ready, failed states)
  - test_cancel_generation_*: Tests for POST /cancel (from queued, from generating, fails for ready/cancelled)
  - test_list_prds_*: Tests for pagination (skip, limit, skip+limit), archived exclusion/inclusion
  - test_soft_delete_prd: Verifies DELETE sets deleted_at
  - test_soft_deleted_prd_excluded_from_list: Verifies soft-deleted PRDs don't appear in list
  - test_soft_deleted_prd_not_accessible_by_id: Verifies soft-deleted PRDs return 404
  - test_export_markdown: Verifies export returns valid markdown with correct headers
  - test_export_json: Verifies JSON export with proper structure
  - test_export_default_format_is_markdown: Verifies default format
  - test_export_fails_for_queued_prd: Verifies export validation
  - test_archive_prd: Verifies archive functionality
  - test_update_prd_*: Tests for title and section updates
  - test_prds_isolated_between_projects: Verifies project isolation
- Helper functions created: _create_test_project, _create_test_requirement, _create_test_prd, _get_project_id, _get_prd_id
- Tests follow existing patterns from test_projects.py and test_prd_service.py
- Files changed:
  - backend/tests/test_prd_api.py (created)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Integration tests use test_client fixture from conftest.py with dependency override
  - Helper functions for creating test data reduce boilerplate significantly
  - Test all HTTP status codes: 200, 201, 202, 204, 400, 404, 422
  - Export tests should verify content-type headers and content-disposition for downloads
  - Soft delete tests should verify both the deleted_at field AND exclusion from queries
  - Test project isolation to ensure multi-tenant behavior is correct
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m ruff check tests/test_prd_api.py` to lint
  - `cd backend && python3 -m pytest tests/test_prd_api.py -v` to run tests
  - `git add . && git commit -m "feat: US-029 - Backend integration tests for PRD endpoints"` to commit
---

## 2026-01-26 - US-030: Backend unit tests for Stories service
- Created comprehensive unit test file at backend/tests/test_stories_service.py
- Implemented 45+ test functions covering all acceptance criteria:
  - test_generate_stories_classic_format: Verifies classic format generates stories with proper structure
  - test_generate_stories_classic_format_creates_story_ids: Verifies US-001 format story IDs
  - test_generate_stories_job_format: Verifies job story format is used correctly
  - test_generate_stories_job_format_uses_correct_prompt: Verifies correct prompt template
  - test_story_number_never_reused: Verifies deleted story numbers aren't reused
  - test_story_number_continues_after_deletion: Verifies numbering continues from max even with all deleted
  - test_story_number_starts_at_one_for_new_project: Verifies first story is US-001
  - test_story_number_with_concurrency: Verifies row lock logic prevents duplicates
  - test_story_numbers_increment_correctly_within_batch: Verifies sequential numbering
  - test_section_filter: Verifies only filtered requirements are used
  - test_section_filter_multiple_sections: Verifies multi-section filtering
  - test_section_filter_empty_result_raises_error: Verifies NoRequirementsError
  - test_section_filter_none_uses_all_sections: Verifies default behavior
  - test_no_requirements_raises_error: Verifies NoRequirementsError for empty project
  - test_no_active_requirements_raises_error: Verifies inactive requirements don't count
  - test_malformed_llm_response_*: Multiple tests for invalid JSON, empty stories, missing fields
  - test_llm_response_with_markdown_code_blocks: Verifies markdown wrapper stripping
  - test_map_size_*: Tests for size string to enum mapping
  - test_generate_stories_task_*: Tests for background task success, cancellation, failure
  - test_load_requirements_*: Tests for requirement loading and grouping
  - test_format_requirements_output: Tests markdown formatting with IDs
  - test_stories_isolated_between_projects: Verifies project isolation
- MockLLMProvider and FailingLLMProvider classes for consistent mocking
- Helper functions: _create_test_project, _create_test_requirement, _create_test_batch, _create_test_story
- Mock story responses: _create_classic_stories(), _create_job_stories()
- Files changed:
  - backend/tests/test_stories_service.py (created)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Stories service tests follow same patterns as PRD service tests for consistency
  - Test story_number continuation with deleted stories: create stories, soft-delete some, generate new, verify numbering
  - MockLLMProvider class pattern works well for testing both generate() and background task
  - Section filter tests need requirements in multiple sections to verify filtering logic
  - Test both explicit section_filter list AND None to verify all-sections default
  - Story ID property (US-XXX) formatting is verified separately from story_number field
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m ruff check tests/test_stories_service.py` to lint
  - `cd backend && python3 -m pytest tests/test_stories_service.py -v` to run tests
  - `git add . && git commit -m "feat: US-030 - Backend unit tests for Stories service"` to commit
---

## 2026-01-26 - US-031: Frontend component tests
- Created comprehensive test file for PRDGeneratorPage at ui/tests/components/PRDGeneratorPage.test.jsx
  - Tests for initial loading state and project fetch
  - Tests for error handling and retry functionality
  - Tests for mode selection (Draft/Detailed) updates state correctly
  - Tests for generate button triggers API call with correct mode
  - Tests for 30-second cooldown timer disabling button
  - Tests for countdown decreasing over time
  - Tests for status polling during generation
  - Tests for navigation to editor on ready status
  - Tests for error display on failed status
  - Tests for cancel generation functionality
  - Tests for error recovery with Try Again button
- Created comprehensive test file for StoryCard at ui/tests/components/StoryCard.test.jsx
  - Tests for collapsed view: story ID, title, size indicator, labels with +N overflow
  - Tests for expand/collapse behavior: header click, button click, state toggle
  - Tests for expanded view: status badge, format badge, description, acceptance criteria, all labels
  - Tests for size indicator with correct CSS class per size (XS, S, M, L, XL)
  - Tests for status classes (draft, ready, exported)
  - Tests for edit action: calls onEdit with story, does not toggle expand
  - Tests for delete action: shows confirmation modal, calls onDelete, shows loading, closes on success
  - Tests for accessibility: aria-labels, button types
- Both test files use Vitest with React Testing Library (RTL) following existing test patterns
- Tests mock API calls using vi.mock() and use fake timers for cooldown testing
- Files changed:
  - ui/tests/components/PRDGeneratorPage.test.jsx (created)
  - ui/tests/components/StoryCard.test.jsx (created)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Use vi.useFakeTimers({ shouldAdvanceTime: true }) for testing timers and polling
  - Wrap timer advances in act() to avoid React warnings
  - Use MemoryRouter with Routes for testing components that use react-router hooks
  - Mock useNavigate by importing actual module and spreading with override
  - StoryCard tests demonstrate testing expand/collapse UI patterns
  - Use .closest() to find parent elements for class assertions
  - Mock functions that return Promises with mockResolvedValue/mockRejectedValue
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd ui && npm test -- tests/components/PRDGeneratorPage.test.jsx tests/components/StoryCard.test.jsx` to run tests
  - `git add . && git commit -m "feat: US-031 - Frontend component tests"` to commit
---

## 2026-01-26 - US-032: E2E tests with Playwright
- Created comprehensive E2E test file at ui/tests/e2e/prd-generation.spec.ts
  - Tests PRD landing page navigation and project selection
  - Tests mode selection (Draft vs Detailed)
  - Tests PRD generation flow: generate, wait for completion, verify editor loads
  - Tests cancel generation functionality
  - Tests error handling and retry button on failure
  - Tests cooldown timer behavior
  - Tests editor functionality: section editing, auto-save, collapse/expand all
  - Tests export modal and markdown download
  - Tests version selector
  - Tests complete end-to-end flow from landing to editor
  - Handles project with no requirements error case
- Created comprehensive E2E test file at ui/tests/e2e/stories-generation.spec.ts
  - Tests stories landing page navigation and project selection
  - Tests format selection (Classic vs Job Story)
  - Tests section filter multi-select dropdown
  - Tests story generation flow: generate, wait for completion, verify stories list
  - Tests info dialog warning about adding stories (not replacing)
  - Tests cancel generation functionality
  - Tests error handling and retry button on failure
  - Tests story card expand/collapse behavior
  - Tests story edit modal with field editing
  - Tests delete story with confirmation dialog
  - Tests batch filter dropdown and filtering
  - Tests batch deletion
  - Tests export modal with format options (Markdown, CSV, JSON)
  - Tests complete end-to-end flow
  - Handles project with no requirements error case
- Both test files follow existing E2E test patterns from happy-path.spec.ts and apply-flow.spec.ts
- Tests use page.route() for API mocking and page.waitForURL() with proper timeouts
- Tests use Playwright's expect assertions with configurable timeouts for async operations
- Files changed:
  - ui/tests/e2e/prd-generation.spec.ts (created)
  - ui/tests/e2e/stories-generation.spec.ts (created)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - E2E tests use page.route() to mock API endpoints - can conditionally return different data based on state
  - Use pollCount variable pattern to simulate generation progress (queued -> generating -> ready)
  - For file downloads, use page.waitForEvent('download') before clicking the download button
  - For modals that appear on certain conditions (like info dialog), test both the dialog and confirmation flow
  - Use page.waitForURL() with wildcard patterns for navigation assertions
  - Test both happy path and error cases (no requirements, LLM timeout, cancelled)
  - CSS class selectors work well for Playwright - no need for data-testid if classes are descriptive
  - Use page.selectOption() for select dropdowns, page.click() for custom dropdowns
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd ui && npx playwright test tests/e2e/prd-generation.spec.ts --headed` to run PRD E2E tests
  - `cd ui && npx playwright test tests/e2e/stories-generation.spec.ts --headed` to run Stories E2E tests
  - `git add . && git commit -m "feat: US-032 - E2E tests with Playwright"` to commit
---

## 2026-01-26 - US-033: Define export schemas for PRD and Stories
- Created explicit Pydantic export schemas for PRD and Stories JSON exports
- PRD schemas added to backend/app/schemas/prd.py:
  - PRDExportSection: Schema for section structure (title, content)
  - PRDExportJSON: Full JSON export schema with documentation (title, version, mode, sections, created_at, updated_at)
- Stories schemas added to backend/app/schemas/user_story.py:
  - StoryExportItem: Schema for individual story in JSON export (12 fields documented)
  - StoriesExportJSON: Wrapper schema for stories array
  - STORIES_CSV_COLUMNS: Constant defining CSV column names and order
- Added comprehensive CSV documentation as comments in user_story.py:
  - Column names and order: Story ID, Title, Description, Acceptance Criteria, Size, Labels, Status, Format
  - Acceptance criteria uses pipe (|) separator
  - Labels are comma-separated
  - Size is uppercase
- Created test file backend/tests/test_export_schemas.py with 11 tests:
  - PRD JSON schema conformance tests (3 tests)
  - Stories JSON schema conformance tests (2 tests)
  - Stories CSV column and format tests (5 tests)
- Updated backend/app/schemas/__init__.py to export new schemas
- Added schema validation test to test_prd_api.py (test_export_json_conforms_to_schema)
- Files changed:
  - backend/app/schemas/prd.py (added PRDExportSection, PRDExportJSON)
  - backend/app/schemas/user_story.py (added StoryExportItem, StoriesExportJSON, STORIES_CSV_COLUMNS, documentation)
  - backend/app/schemas/__init__.py (added new exports)
  - backend/tests/test_export_schemas.py (created with 11 tests)
  - backend/tests/test_prd_api.py (added schema validation test)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Export schemas should be Pydantic models with docstrings documenting field order and formats
  - Use constants (like STORIES_CSV_COLUMNS) for column names to enable programmatic access in tests
  - CSV format documentation as comments is sufficient when also tested in test files
  - Schema validation tests use model_validate() to verify endpoint output conforms to documented schema
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m ruff check app/schemas/prd.py app/schemas/user_story.py app/schemas/__init__.py tests/test_export_schemas.py` to lint
  - `cd backend && python3 -m pytest tests/test_export_schemas.py -v` to run schema tests
  - `cd backend && python3 -m pytest tests/test_prd_api.py::test_export_json_conforms_to_schema -v` to run PRD schema test
  - `git add . && git commit -m "feat: US-033 - Define export schemas for PRD and Stories"` to commit
---

## 2026-01-26 - US-034: Enforce project access for PRD and Story endpoints
- Updated `_get_prd_or_404()` in prds.py to include project access verification
- Updated `_get_story_or_404()` and `_get_batch_or_404()` in stories.py to include project access verification
- All three helper functions now verify the associated project exists when fetching a resource by ID
- Added verify_project_access parameter (default True) for flexibility in internal calls
- Implementation returns 404 (consistent with existing patterns) when project doesn't exist
- Includes comments explaining where auth checks would be added when authentication is implemented
- Added 8 project access enforcement tests to test_prd_api.py:
  - test_get_prd_returns_404_when_project_deleted
  - test_update_prd_returns_404_when_project_deleted
  - test_delete_prd_returns_404_when_project_deleted
  - test_prd_status_returns_404_when_project_deleted
  - test_cancel_prd_returns_404_when_project_deleted
  - test_archive_prd_returns_404_when_project_deleted
  - test_export_prd_returns_404_when_project_deleted
  - test_prd_accessible_when_project_exists (positive case)
- Created test_stories_api.py with 8 project access enforcement tests:
  - test_get_story_returns_404_when_project_deleted
  - test_update_story_returns_404_when_project_deleted
  - test_delete_story_returns_404_when_project_deleted
  - test_batch_status_returns_404_when_project_deleted
  - test_cancel_batch_returns_404_when_project_deleted
  - test_story_accessible_when_project_exists (positive case)
  - test_batch_accessible_when_project_exists (positive case)
- Files changed:
  - backend/app/routers/prds.py (updated _get_prd_or_404 with project access check)
  - backend/app/routers/stories.py (updated _get_batch_or_404 and _get_story_or_404 with project access checks)
  - backend/tests/test_prd_api.py (added 8 project access tests)
  - backend/tests/test_stories_api.py (created with 8 project access tests)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Project access checks are implemented in the helper functions (_get_*_or_404) that are called by all endpoints
  - This ensures consistent access enforcement without modifying each endpoint individually
  - Returns 404 (not 403) per existing patterns since there's no auth yet - avoids information disclosure
  - verify_project_access parameter allows flexibility for internal operations if needed
  - When auth is implemented, these helper functions will be extended to also check user permissions
  - test_stories_api.py will be expanded in US-036 for comprehensive stories API coverage
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m ruff check app/routers/prds.py app/routers/stories.py tests/test_prd_api.py tests/test_stories_api.py` to lint
  - `cd backend && python3 -m pytest tests/test_prd_api.py -v -k "project_deleted or project_exists"` to run PRD project access tests
  - `cd backend && python3 -m pytest tests/test_stories_api.py -v` to run stories project access tests
  - `git add . && git commit -m "feat: US-034 - Enforce project access for PRD and Story endpoints"` to commit
---

## 2026-01-26 - US-035: Make PRD version assignment atomic at creation
- Created `assign_version_atomically()` method in PRDGenerator class
- This method atomically:
  1. Acquires row-level lock on Project using with_for_update()
  2. Queries max version for the project
  3. Updates PRD with version, title, sections, raw_markdown, status
  4. Commits the transaction (releasing the lock)
- Updated `generate()` method to use `assign_version_atomically()` instead of separate `_get_next_version()` call
- Updated `generate_prd_task()` background task to use `assign_version_atomically()` for atomic version assignment
- Added comprehensive documentation explaining the locking behavior
- Added 8 new tests to test_prd_service.py:
  - test_assign_version_atomically_assigns_correct_version
  - test_assign_version_atomically_increments_from_existing
  - test_assign_version_atomically_updates_all_fields
  - test_assign_version_atomically_commits_transaction
  - test_generate_uses_atomic_version_assignment
  - test_no_duplicate_versions_with_sequential_generations
  - test_version_assignment_includes_deleted_prds
- Files changed:
  - backend/app/services/prd_generator.py (added assign_version_atomically method, refactored generate and generate_prd_task)
  - backend/tests/test_prd_service.py (added 8 new tests for atomic version assignment)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Use `assign_version_atomically()` pattern when multiple operations must happen atomically with a row lock
  - The method commits the transaction to release the lock - callers should not commit again
  - Row-level locking with `with_for_update()` serializes concurrent access until transaction commits
  - Version numbers are never reused even for soft-deleted PRDs (queries MAX which includes all records)
  - SQLite's FOR UPDATE is a no-op in tests, but logic is validated; true locking requires PostgreSQL
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m ruff check app/services/prd_generator.py` to lint
  - `cd backend && python3 -m pytest tests/test_prd_service.py -v -k "atomic or assign_version"` to run new tests
  - `cd backend && python3 -m pytest tests/test_prd_service.py -v` to run all PRD service tests
  - `git add . && git commit -m "feat: US-035 - Make PRD version assignment atomic at creation"` to commit
---

## 2026-01-26 - US-036: Backend integration tests for Stories API endpoints
- Expanded backend/tests/test_stories_api.py with comprehensive API integration tests
- Added 60+ test functions covering all acceptance criteria:
  - test_generate_returns_queued_status: POST /generate returns batch with status=queued (202)
  - test_generate_returns_404_for_missing_project: Verifies 404 for non-existent project
  - test_generate_validates_format: Verifies format field validation
  - test_generate_with_section_filter: Verifies section_filter parameter
  - test_generate_with_job_story_format: Verifies job_story format acceptance
  - test_batch_status_polling_*: Tests for GET /batches/{id}/status (queued, generating, ready with count, failed with error)
  - test_cancel_batch_*: Tests for POST /batches/{id}/cancel (from queued, from generating, fails for ready/cancelled/failed)
  - test_list_stories_pagination_*: Tests for pagination (default, skip, limit, skip+limit)
  - test_list_stories_filter_*: Tests for filters (batch_id, status, labels, multiple labels, combined)
  - test_soft_delete_story_*: Tests for soft delete (sets deleted_at, excludes from list, returns 404)
  - test_delete_batch_*: Tests for batch deletion (deletes all stories, deletes batch record, 404 for wrong project)
  - test_reorder_stories_*: Tests for reorder (updates order, respects new order in list, fails for invalid ID, fails for different project)
  - test_export_csv_*: Tests for CSV export (correct columns, pipe-separated AC, content-disposition, batch filter)
  - test_export_json_*: Tests for JSON export (matches schema, multiple stories, content-disposition)
  - test_export_markdown_*: Tests for markdown export (format, default format, 404 when no stories)
  - test_update_story_*: Tests for update (title, all fields, partial updates)
  - test_list_batches_*: Tests for batch listing (returns all, sorted by date, isolated between projects)
  - test_stories_isolated_between_projects: Verifies project isolation
- Added _create_test_requirement helper function
- Enhanced _create_test_story with additional parameters (description, acceptance_criteria, labels, size, status, format, order)
- Tests use existing conftest.py fixtures (test_db, test_client)
- Files changed:
  - backend/tests/test_stories_api.py (comprehensive expansion from 8 to 60+ tests)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Stories API tests follow same patterns as PRD API tests for consistency
  - Use helper functions with sensible defaults to reduce test boilerplate
  - Test all filter combinations (batch_id, status, labels) individually and combined
  - CSV export tests should use csv.reader to parse and verify content
  - JSON export tests should verify all schema fields are present
  - Batch deletion tests should verify both stories and batch record are deleted
  - Reorder tests should verify both order field updates and list order
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m ruff check tests/test_stories_api.py` to lint
  - `cd backend && python3 -m pytest tests/test_stories_api.py -v` to run all tests
  - `git add . && git commit -m "feat: US-036 - Backend integration tests for Stories API endpoints"` to commit
---

## 2026-01-26 - US-037: Error handling edge cases
- Verified comprehensive error handling already exists in backend services and frontend components
- Added additional integration tests to verify error messages are properly surfaced via API
- Backend error handling verification:
  - NoRequirementsError is caught in background tasks, sets status=failed with helpful message "Project X has no requirements"
  - LLM timeout is handled by providers (httpx.TimeoutException → LLMError("...timed out"))
  - LLMResponseError includes parsing error details in error_message
  - Concurrent version/story number handled by atomic version assignment (US-035) with row-level locking
  - Cancel on completed/cancelled/failed returns 400 with "Cannot cancel" message (not 500)
  - All resource access returns 404 for non-existent resources
- Frontend error handling verification:
  - PRDGeneratorPage displays statusResponse.error_message in error panel
  - UserStoriesPage displays statusResponse.error_message in error panel
  - Both pages have handleRetry function that clears error and resets state without page refresh
  - Error messages are displayed with icon and "Try Again" button
- Added error handling edge case tests to test_prd_api.py:
  - test_failed_prd_includes_error_message_in_status
  - test_failed_prd_with_timeout_includes_specific_message
  - test_failed_prd_with_parsing_error_includes_details
  - test_cancel_returns_400_not_500_for_failed_prd
  - test_update_non_existent_prd_returns_404
  - test_archive_non_existent_prd_returns_404
  - test_export_with_invalid_format_returns_422
  - test_list_prds_with_invalid_skip_returns_422
  - test_list_prds_with_invalid_limit_returns_422
- Added error handling edge case tests to test_stories_api.py:
  - test_failed_batch_includes_error_message_in_status
  - test_failed_batch_with_timeout_includes_specific_message
  - test_failed_batch_with_parsing_error_includes_details
  - test_cancel_returns_400_not_500_for_completed_batch
  - test_update_non_existent_story_returns_404
  - test_delete_non_existent_story_returns_404
  - test_get_non_existent_batch_returns_404
  - test_export_with_invalid_format_returns_422
  - test_list_stories_with_invalid_batch_id_returns_empty
  - test_reorder_with_empty_story_ids_returns_success
- Files changed:
  - backend/tests/test_prd_api.py (added 9 error handling tests)
  - backend/tests/test_stories_api.py (added 10 error handling tests)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Error handling is implemented in background tasks, not in the API endpoints themselves
  - API endpoints return proper HTTP status codes (400 for client errors, 404 for not found, 422 for validation)
  - Error messages from NoRequirementsError, LLMResponseError, and LLMError are passed through to the status response
  - Frontend displays error_message from status polling response, provides retry button
  - Test that 400 is returned (not 500) for expected error cases like cancel on completed
  - Test that helpful error messages are included, not just generic "failed" status
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m ruff check tests/test_prd_api.py tests/test_stories_api.py` to lint
  - `cd backend && python3 -m pytest tests/test_prd_api.py tests/test_stories_api.py -v -k "error or 404 or 422 or cancel"` to run error handling tests
  - `cd backend && python3 -m pytest tests/ -v` to run all tests
  - `git add . && git commit -m "feat: US-037 - Error handling edge cases"` to commit
---

## 2026-01-26 - US-038: Fix story number locking to prevent duplicates in concurrent generation
- Replaced `_get_next_story_number()` with `_reserve_story_numbers(project_id, count)` method
- New method reserves ALL story numbers for a batch atomically BEFORE the loop
- Row-level lock on Project is acquired once with `with_for_update()` and held until transaction commits
- Updated `generate()` method to:
  1. Parse LLM response to get story count
  2. Call `_reserve_story_numbers(project_id, len(stories_data))` to reserve numbers
  3. Use reserved numbers in the loop (no lock acquisition per story)
  4. Commit at end releases the lock
- Updated `generate_stories_task()` background task to use same atomic reservation approach
- Added 10 new tests to test_stories_service.py:
  - test_reserve_story_numbers_returns_sequential_list
  - test_reserve_story_numbers_continues_from_max
  - test_reserve_story_numbers_includes_deleted_stories
  - test_reserve_story_numbers_zero_count_returns_empty
  - test_reserve_story_numbers_negative_count_returns_empty
  - test_batch_generation_uses_reserved_numbers
  - test_concurrent_batches_get_non_overlapping_numbers
  - test_background_task_uses_atomic_reservation
  - test_no_duplicate_story_numbers_after_multiple_generations
- Updated existing test `test_story_number_starts_at_one_for_new_project` to use new method
- Files changed:
  - backend/app/services/stories_generator.py (replaced _get_next_story_number with _reserve_story_numbers)
  - backend/tests/test_stories_service.py (added 10 new tests, updated 1 existing test)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - Use batch reservation pattern when multiple records need sequential numbers from same source
  - The key insight: reserve numbers BEFORE the loop, not inside it
  - Method returns list[int] so caller can iterate with index: `story_numbers[i]`
  - Lock is held until commit, so all stories get atomic numbers even if later operations fail
  - Edge cases (count=0 or negative) return empty list to avoid errors
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m ruff check app/services/stories_generator.py tests/test_stories_service.py` to lint
  - `cd backend && python3 -m pytest tests/test_stories_service.py -v -k "reserve_story" ` to run new tests
  - `cd backend && python3 -m pytest tests/test_stories_service.py -v` to run all stories service tests
  - `git add . && git commit -m "feat: US-038 - Fix story number locking to prevent duplicates in concurrent generation"` to commit
---

## 2026-01-26 - US-039: Fix labels filter to use proper JSON array matching
- Fixed labels filter in stories.py to use exact array element matching instead of simple LIKE pattern
- Problem: Previous pattern `%"label"%` matched partial strings (e.g., 'frontend' matched 'not-frontend')
- Solution: Use OR conditions to match labels at exact positions in JSON array:
  - `'["label"]'` - single element array
  - `'["label",%'` / `'["label", %'` - first element (with/without space)
  - `'%, "label", %'` / `'%,"label",%'` - middle element (with/without spaces)
  - `'%, "label"]'` / `'%,"label"]'` - last element (with/without space)
- Added `or_` import from sqlalchemy
- Added 8 comprehensive test cases to test_stories_api.py:
  - test_labels_filter_does_not_match_partial_prefix
  - test_labels_filter_does_not_match_partial_suffix
  - test_labels_filter_matches_single_element_array
  - test_labels_filter_matches_first_element_in_array
  - test_labels_filter_matches_middle_element_in_array
  - test_labels_filter_matches_last_element_in_array
  - test_labels_filter_with_multiple_labels_all_exact
  - test_labels_filter_no_match_for_similar_labels
- Files changed:
  - backend/app/routers/stories.py (updated labels filter with exact matching patterns)
  - backend/tests/test_stories_api.py (added 8 new tests for exact label matching)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - JSON arrays are stored as strings with potential spacing variations (e.g., `["a", "b"]` vs `["a","b"]`)
  - When matching JSON array elements with LIKE, must account for element position: single, first, middle, last
  - Include patterns for both spaced and non-spaced JSON serialization formats
  - Use SQLAlchemy's `or_()` to combine multiple LIKE patterns efficiently
  - Test edge cases: partial prefix match, partial suffix match, element at each position
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m ruff check app/routers/stories.py` to lint
  - `cd backend && python3 -m pytest tests/test_stories_api.py -v -k "labels_filter"` to run labels filter tests
  - `cd backend && python3 -m pytest tests/test_stories_api.py -v` to run all stories API tests
  - `git add . && git commit -m "feat: US-039 - Fix labels filter to use proper JSON array matching"` to commit
---

## 2026-01-26 - US-040: Apply LLM configuration parameters to provider calls
- Updated LLMProvider base class to accept optional temperature, max_tokens, timeout parameters in generate()
- Updated ClaudeProvider.generate() to:
  - Accept temperature, max_tokens, timeout parameters
  - Create per-request client with specific timeout
  - Pass temperature and max_tokens to messages.create()
  - Added DEFAULT_TEMPERATURE (0.7) and DEFAULT_MAX_TOKENS (4096) class constants
- Updated OllamaProvider.generate() to:
  - Accept temperature, max_tokens, timeout parameters
  - Pass temperature and num_predict (Ollama's max tokens) in options payload
  - Use provided timeout for httpx.Client
  - Added DEFAULT_TEMPERATURE (0.7) and DEFAULT_MAX_TOKENS (4096) class constants
- Updated PRDGenerator to pass PRD-specific config (timeout=120s, temperature=0.7, max_tokens=8000) to provider.generate()
- Updated StoriesGenerator to pass stories-specific config (timeout=90s, temperature=0.5, max_tokens=4000) to provider.generate()
- Both generate() method and generate_*_task() background tasks now pass the configuration
- Added TimeoutLLMProvider mock class for testing timeout scenarios
- Added comprehensive tests in test_prd_service.py (6 new tests):
  - test_generate_passes_llm_config_parameters
  - test_generate_prd_task_passes_llm_config_parameters
  - test_prd_llm_config_values_are_correct
  - test_generate_handles_llm_timeout_error
  - test_generate_prd_task_records_timeout_error_in_status
- Added comprehensive tests in test_stories_service.py (6 new tests):
  - test_generate_passes_llm_config_parameters
  - test_generate_stories_task_passes_llm_config_parameters
  - test_stories_llm_config_values_are_correct
  - test_generate_handles_llm_timeout_error
  - test_generate_stories_task_records_timeout_error_in_status
- Updated MockLLMProvider and FailingLLMProvider in all test files to accept new parameters:
  - test_prd_service.py, test_stories_service.py, test_merger.py, test_extractor.py, test_conflict.py, test_apply.py
- Files changed:
  - backend/app/services/llm/base.py (updated generate() signature)
  - backend/app/services/llm/claude.py (updated generate() with config params)
  - backend/app/services/llm/ollama.py (updated generate() with config params)
  - backend/app/services/prd_generator.py (pass config to provider)
  - backend/app/services/stories_generator.py (pass config to provider)
  - backend/tests/test_prd_service.py (added TimeoutLLMProvider, updated mocks, added 6 tests)
  - backend/tests/test_stories_service.py (added TimeoutLLMProvider, updated mocks, added 6 tests)
  - backend/tests/test_merger.py (updated MockLLMProvider signature)
  - backend/tests/test_extractor.py (updated MockLLMProvider signature)
  - backend/tests/test_conflict.py (updated MockLLMProvider signature)
  - backend/tests/test_apply.py (updated MockLLMProvider signature)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - LLM configuration should be passed at call time, not just at provider init, for operation-specific settings
  - Claude uses temperature and max_tokens directly; Ollama uses options.temperature and options.num_predict
  - Per-request clients allow different timeouts for different operations
  - Keyword-only parameters (*,) enforce explicit naming and prevent positional misuse
  - All mock providers must match the real interface signature for tests to pass
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m ruff check app/services/llm/ app/services/prd_generator.py app/services/stories_generator.py` to lint
  - `cd backend && python3 -m pytest tests/test_prd_service.py -v -k "llm_config or timeout"` to run PRD config tests
  - `cd backend && python3 -m pytest tests/test_stories_service.py -v -k "llm_config or timeout"` to run stories config tests
  - `cd backend && python3 -m pytest tests/ -v` to run all tests
  - `git add . && git commit -m "feat: US-040 - Apply LLM configuration parameters to provider calls"` to commit
---

## 2026-01-26 - US-041: Add database unique constraints for version and story number
- Added UniqueConstraint to PRD model for (project_id, version) in __table_args__
- Added UniqueConstraint to UserStory model for (project_id, story_number) in __table_args__
- Created Alembic migration `f3a2b5c8d9e1_add_unique_constraints_for_version_and_story_number.py`:
  - Drops existing non-unique index ix_prds_project_version on prds table
  - Creates unique index uq_prds_project_version on prds (project_id, version)
  - Drops existing non-unique index ix_user_stories_project_story_number on user_stories table
  - Creates unique index uq_user_stories_project_story_number on user_stories (project_id, story_number)
  - Downgrade restores the original non-unique indexes
- Added 4 unique constraint tests to test_prd_service.py:
  - test_duplicate_prd_version_raises_integrity_error: Verifies IntegrityError on duplicate version
  - test_different_projects_can_have_same_prd_version: Verifies different projects can share versions
  - test_same_project_can_have_different_prd_versions: Verifies multiple versions per project
  - test_unique_constraint_applies_to_all_prd_statuses: Verifies constraint includes soft-deleted
- Added 5 unique constraint tests to test_stories_service.py:
  - test_duplicate_story_number_raises_integrity_error: Verifies IntegrityError on duplicate story_number
  - test_different_projects_can_have_same_story_number: Verifies different projects can share story numbers
  - test_same_project_can_have_different_story_numbers: Verifies multiple story numbers per project
  - test_unique_constraint_applies_to_all_story_statuses: Verifies constraint includes soft-deleted
  - test_unique_constraint_across_batches_in_same_project: Verifies constraint is project-scoped not batch-scoped
- Files changed:
  - backend/app/models/prd.py (added UniqueConstraint import and __table_args__)
  - backend/app/models/user_story.py (added UniqueConstraint import and __table_args__)
  - backend/alembic/versions/f3a2b5c8d9e1_add_unique_constraints_for_version_and_story_number.py (created)
  - backend/tests/test_prd_service.py (added 4 unique constraint tests)
  - backend/tests/test_stories_service.py (added 5 unique constraint tests)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - UniqueConstraint in __table_args__ tuple creates the constraint at table creation
  - Alembic migration drops old non-unique index and creates unique index to enforce constraint on existing databases
  - Unique constraints apply to all records including soft-deleted ones (constraint is on raw data, not filtered)
  - Story number uniqueness is per project, not per batch - batches are just grouping mechanism
  - Tests use pytest.raises(IntegrityError) and require db.rollback() after expected failure
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m ruff check app/models/prd.py app/models/user_story.py alembic/versions/f3a2b5c8d9e1_add_unique_constraints_for_version_and_story_number.py` to lint
  - `cd backend && python3 -m alembic upgrade head` to apply migration
  - `cd backend && python3 -m alembic downgrade -1` to test rollback
  - `cd backend && python3 -m alembic upgrade head` to reapply
  - `cd backend && python3 -m pytest tests/test_prd_service.py -v -k "constraint"` to run PRD constraint tests
  - `cd backend && python3 -m pytest tests/test_stories_service.py -v -k "constraint"` to run stories constraint tests
  - `git add . && git commit -m "feat: US-041 - Add database unique constraints for version and story number"` to commit
---

## 2026-01-26 - US-042: Add session rollback before error status commit in background tasks
- Updated generate_prd_task() in prd_generator.py to call db.rollback() before setting status=failed
- Updated generate_stories_task() in stories_generator.py to call db.rollback() before setting status=failed
- Both background tasks now:
  1. Call db.rollback() to clear any pending changes
  2. Re-fetch the PRD/batch from database to re-attach to the session
  3. Set status to FAILED with error message
  4. Commit only the error status update
- This ensures partial PRD data or partial story creation is not persisted when errors occur
- Added 7 new tests to test_prd_service.py:
  - test_generate_prd_task_rollback_on_no_requirements
  - test_generate_prd_task_rollback_on_llm_error
  - test_generate_prd_task_rollback_on_parse_error
  - test_generate_prd_task_rollback_on_unexpected_error
  - test_generate_prd_task_rollback_cleans_up_prd_in_bad_state
  - test_generate_prd_task_only_error_status_committed_after_rollback
- Added 8 new tests to test_stories_service.py:
  - test_generate_stories_task_rollback_on_no_requirements
  - test_generate_stories_task_rollback_on_llm_error
  - test_generate_stories_task_rollback_on_parse_error
  - test_generate_stories_task_rollback_on_unexpected_error
  - test_generate_stories_task_rollback_partial_story_creation
  - test_generate_stories_task_only_error_status_committed_after_rollback
  - test_generate_stories_task_rollback_prevents_orphan_stories
- Files changed:
  - backend/app/services/prd_generator.py (added rollback in exception handlers)
  - backend/app/services/stories_generator.py (added rollback in exception handlers)
  - backend/tests/test_prd_service.py (added 7 rollback tests)
  - backend/tests/test_stories_service.py (added 8 rollback tests)
  - docs/prd-user-stories.json (updated passes: true)
- **Learnings for future iterations:**
  - After calling db.rollback(), objects attached to the session are detached and must be re-fetched
  - Re-fetching with db.query().filter().first() re-attaches the object to the session
  - This pattern ensures a clean slate before recording error status
  - The if check after re-fetch handles the case where the record was deleted during processing
  - SQLAlchemy rollback() discards all pending changes, including flushed but uncommitted changes
- **Manual verification needed:** Shell commands unavailable - run the following to verify:
  - `cd backend && python3 -m ruff check app/services/prd_generator.py app/services/stories_generator.py tests/test_prd_service.py tests/test_stories_service.py` to lint
  - `cd backend && python3 -m pytest tests/test_prd_service.py -v -k "rollback"` to run PRD rollback tests
  - `cd backend && python3 -m pytest tests/test_stories_service.py -v -k "rollback"` to run stories rollback tests
  - `cd backend && python3 -m pytest tests/ -v` to run all tests
  - `git add . && git commit -m "feat: US-042 - Add session rollback before error status commit in background tasks"` to commit
---
