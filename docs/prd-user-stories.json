{
  "project": "CX AIA for Product Manager - PRD & User Stories Generation",
  "branchName": "ralph/prd-user-stories-generation",
  "description": "Add PRD generation and User Stories generation features to transform requirements into structured PRD documents and actionable development stories",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create PRD model with status enum and fields",
      "description": "As a developer, I want a PRD SQLAlchemy model with proper status tracking, so that PRD generation state can be persisted and managed.",
      "acceptanceCriteria": [
        "PRD model exists at backend/app/models/prd.py",
        "PRDMode enum has DRAFT and DETAILED values",
        "PRDStatus enum has QUEUED, GENERATING, READY, FAILED, CANCELLED, ARCHIVED values",
        "PRD model has all fields: id (UUID), project_id, version (int), title, mode, sections (JSON), raw_markdown, status, error_message, created_by, updated_by, created_at, updated_at, deleted_at",
        "PRD model has ForeignKey to projects.id",
        "Model is exported from models/__init__.py"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Follow existing model patterns in backend/app/models/. Use sqlalchemy Enum for status and mode fields."
    },
    {
      "id": "US-002",
      "title": "Create UserStory model with format and status enums",
      "description": "As a developer, I want a UserStory SQLAlchemy model with story format tracking, so that user stories can be persisted with all their metadata.",
      "acceptanceCriteria": [
        "UserStory model exists at backend/app/models/user_story.py",
        "StoryFormat enum has CLASSIC and JOB_STORY values",
        "StoryStatus enum has DRAFT, READY, EXPORTED values",
        "StorySize enum has XS, S, M, L, XL values",
        "UserStory model has all fields: id, project_id, batch_id, story_number, format, title, description, acceptance_criteria (JSON), order, labels (JSON), size, requirement_ids (JSON), status, created_by, updated_by, created_at, updated_at, deleted_at",
        "UserStory has a story_id property that returns 'US-{story_number:03d}'",
        "Model is exported from models/__init__.py"
      ],
      "priority": 2,
      "passes": true,
      "notes": "story_number should never be reused even when stories are deleted. Use @property decorator for story_id computed field."
    },
    {
      "id": "US-003",
      "title": "Create StoryBatch model for generation tracking",
      "description": "As a developer, I want a StoryBatch SQLAlchemy model, so that each story generation run can be tracked separately.",
      "acceptanceCriteria": [
        "StoryBatch model exists at backend/app/models/story_batch.py",
        "StoryBatchStatus enum has QUEUED, GENERATING, READY, FAILED, CANCELLED values",
        "StoryBatch has fields: id, project_id, format, section_filter (JSON), story_count, status, error_message, created_by, created_at",
        "StoryBatch has ForeignKey to projects.id",
        "Model is exported from models/__init__.py"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Batches group stories from a single generation run. story_count is updated after generation completes."
    },
    {
      "id": "US-004",
      "title": "Create Alembic migration for new tables",
      "description": "As a developer, I want Alembic migrations for the new models, so that the database schema is updated correctly.",
      "acceptanceCriteria": [
        "Migration creates prds table with all columns and indexes",
        "Migration creates user_stories table with all columns and indexes",
        "Migration creates story_batches table with all columns and indexes",
        "Migration includes foreign key constraints to projects table",
        "Migration runs successfully with alembic upgrade head",
        "Migration can be rolled back with alembic downgrade"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Use 'alembic revision --autogenerate -m \"add prd and user story tables\"'. Ensure models are imported in alembic/env.py."
    },
    {
      "id": "US-005",
      "title": "Create Pydantic schemas and exception classes",
      "description": "As a developer, I want Pydantic schemas for PRD and Stories API requests/responses, so that the API has proper validation and serialization.",
      "acceptanceCriteria": [
        "PRD schemas exist at backend/app/schemas/prd.py with: PRDGenerateRequest, PRDStatusResponse, PRDSection, PRDResponse, PRDSummary, PRDUpdateRequest, ExportFormat",
        "UserStory schemas exist at backend/app/schemas/user_story.py with: StoriesGenerateRequest, StoryBatchStatusResponse, UserStoryResponse, StoryUpdateRequest, ReorderRequest, StoryBatchResponse, StoryExportFormat",
        "PaginatedResponse generic schema is available",
        "Exception classes exist: PRDGenerationError, NoRequirementsError, LLMResponseError, GenerationTimeoutError, GenerationCancelledError",
        "Schemas are exported from schemas/__init__.py"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Use Generic[T] for PaginatedResponse. Follow existing schema patterns in the codebase."
    },
    {
      "id": "US-006",
      "title": "Create PRD generation prompt templates",
      "description": "As a developer, I want prompt templates for PRD generation, so that the LLM produces properly structured PRD content.",
      "acceptanceCriteria": [
        "Draft mode prompt exists at backend/app/prompts/generate_prd_draft_v1.txt",
        "Detailed mode prompt exists at backend/app/prompts/generate_prd_detailed_v1.txt",
        "Draft prompt emphasizes gaps, open questions, and areas needing clarification",
        "Detailed prompt covers all 12 sections: executive summary, problem statement, goals, target users, solution, functional reqs, non-functional reqs, technical considerations, metrics, timeline, risks, appendix",
        "Both prompts specify JSON output format with title and sections array",
        "Prompts include {requirements_by_section} placeholder"
      ],
      "priority": 6,
      "passes": true,
      "notes": "See implementation plan for exact prompt text. Draft mode has 7 sections, Detailed mode has 12 sections."
    },
    {
      "id": "US-007",
      "title": "Implement PRDGenerator service with background tasks",
      "description": "As a developer, I want a PRDGenerator service class, so that PRD generation can be performed asynchronously with proper error handling.",
      "acceptanceCriteria": [
        "PRDGenerator service exists at backend/app/services/prd_generator.py",
        "generate() method loads project requirements, builds prompt, calls LLM, parses response",
        "_get_next_version() uses row-level lock (SELECT ... FOR UPDATE) to prevent race conditions",
        "_build_prompt() loads appropriate template based on mode",
        "_parse_response() extracts title, sections, and generates markdown",
        "NoRequirementsError is raised when project has no requirements",
        "LLMResponseError is raised on malformed LLM response",
        "Background task function generate_prd_task() handles status transitions correctly",
        "Background task checks for cancelled status before and after LLM call to prevent saving results if cancelled",
        "LLM configuration uses temperature=0.7, max_tokens=8000, timeout=120 for PRD generation"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Use with_for_update() for row locking. Check for cancelled status before starting generation. LLM config should be centralized in config/llm.py or similar."
    },
    {
      "id": "US-008",
      "title": "Create PRD router with all endpoints",
      "description": "As a developer, I want a PRD router with CRUD and generation endpoints, so that the frontend can interact with PRD features.",
      "acceptanceCriteria": [
        "PRD router exists at backend/app/routers/prds.py",
        "POST /projects/{project_id}/prds/generate creates PRD with status=queued and returns immediately",
        "GET /prds/{prd_id}/status returns current generation status (for polling)",
        "POST /prds/{prd_id}/cancel sets status=cancelled if queued or generating",
        "GET /projects/{project_id}/prds lists PRDs with pagination and include_archived filter",
        "GET /prds/{prd_id} returns single PRD with all sections",
        "PUT /prds/{prd_id} updates PRD content (title, sections)",
        "DELETE /prds/{prd_id} soft deletes PRD (sets deleted_at)",
        "POST /prds/{prd_id}/archive sets status to archived",
        "GET /prds/{prd_id}/export returns PRD in markdown or JSON format",
        "All PRD read/write endpoints enforce project access for the current user"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Use BackgroundTasks for generation. Export endpoint should return StreamingResponse with appropriate content-type."
    },
    {
      "id": "US-009",
      "title": "Register PRD router in main.py",
      "description": "As a developer, I want the PRD router registered in the FastAPI app, so that PRD endpoints are accessible.",
      "acceptanceCriteria": [
        "prds router is imported in backend/app/main.py",
        "prds router is included with app.include_router()",
        "All PRD endpoints are accessible via API",
        "OpenAPI docs show PRD endpoints under 'prds' tag"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Follow the pattern used for existing routers in main.py."
    },
    {
      "id": "US-010",
      "title": "Create PRDLandingPage with project selection",
      "description": "As a user, I want a PRD landing page where I can select a project, so that I can start PRD generation for any project.",
      "acceptanceCriteria": [
        "PRDLandingPage component exists at ui/src/pages/PRDLandingPage.jsx",
        "Page displays feature description and purpose",
        "Project selector dropdown shows all available projects",
        "Selecting a project navigates to /app/projects/{projectId}/prd",
        "Page handles loading and error states for project list",
        "API service functions added to ui/src/services/api.js: generatePRD(), getPRDStatus(), cancelPRDGeneration(), getPRD(), updatePRD(), listPRDs(), deletePRD(), exportPRD()"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Follow existing LandingPage patterns. Use existing project API to fetch project list. API functions should follow existing patterns in api.js."
    },
    {
      "id": "US-011",
      "title": "Create PRDGeneratorPage with options and polling",
      "description": "As a user, I want a PRD generator page with mode selection and generation status, so that I can generate and monitor PRD creation.",
      "acceptanceCriteria": [
        "PRDGeneratorPage component exists at ui/src/pages/PRDGeneratorPage.jsx",
        "Mode selector shows Draft and Detailed options with descriptions",
        "Generate button starts generation and shows loading state",
        "30-second cooldown prevents rapid re-generation",
        "Progress overlay shows during generation with cancel button",
        "Status polling every 2 seconds until generation completes",
        "On ready status, navigates to PRD editor page",
        "On failed status, shows error message and allows retry",
        "On cancelled status, clears loading state"
      ],
      "priority": 11,
      "passes": true,
      "notes": "Use useState for isGenerating, cooldownUntil, status, error. Polling should continue until status is ready/failed/cancelled."
    },
    {
      "id": "US-012",
      "title": "Create PRDEditorPage with section editor",
      "description": "As a user, I want a PRD editor page where I can view and edit PRD sections, so that I can refine the generated content.",
      "acceptanceCriteria": [
        "PRDEditorPage component exists at ui/src/pages/PRDEditorPage.jsx",
        "Page fetches PRD by ID from URL params",
        "Table of contents sidebar shows all sections with scroll-to navigation",
        "Each section is collapsible with markdown editor",
        "Auto-save with 1 second debounce on content changes",
        "Save indicator shows Saved/Saving/Error status",
        "Warning shown when navigating away with unsaved changes",
        "Collapse/expand all button in sidebar"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Use useMemo with debounce for auto-save. Handle beforeunload event for unsaved changes warning."
    },
    {
      "id": "US-013",
      "title": "Create PRDExportModal and PRDVersionSelector",
      "description": "As a user, I want to export PRDs and switch between versions, so that I can download my work and compare versions.",
      "acceptanceCriteria": [
        "PRDExportModal component shows format options (Markdown, JSON)",
        "Download button triggers file download with appropriate filename",
        "PRDVersionSelector dropdown shows all versions with creation dates",
        "Selecting a version navigates to that PRD's editor page",
        "Current version is highlighted in selector"
      ],
      "priority": 13,
      "passes": true,
      "notes": "Export downloads from /prds/{id}/export?format=markdown|json. Version selector fetches list from /projects/{id}/prds."
    },
    {
      "id": "US-014",
      "title": "Update LandingPage to enable PRD card",
      "description": "As a user, I want to see an enabled PRD card on the landing page, so that I can navigate to the PRD feature.",
      "acceptanceCriteria": [
        "PRD feature card exists in LandingPage.jsx",
        "Card has title 'Generate PRD' and description",
        "Card links to /app/prd",
        "Card is enabled (not grayed out)"
      ],
      "priority": 14,
      "passes": true,
      "notes": "Find the features array in LandingPage.jsx and update the PRD card to enabled: true."
    },
    {
      "id": "US-015",
      "title": "Add PRD routes to App.jsx",
      "description": "As a developer, I want PRD routes configured in the router, so that PRD pages are accessible via URL navigation.",
      "acceptanceCriteria": [
        "Route /app/prd renders PRDLandingPage",
        "Route /app/projects/:projectId/prd renders PRDGeneratorPage",
        "Route /app/prds/:prdId renders PRDEditorPage",
        "All routes are protected by authentication"
      ],
      "priority": 15,
      "passes": true,
      "notes": "Follow existing route patterns in App.jsx. Import the new page components."
    },
    {
      "id": "US-016",
      "title": "Create story generation prompt templates",
      "description": "As a developer, I want prompt templates for user story generation, so that the LLM produces properly formatted stories.",
      "acceptanceCriteria": [
        "Classic format prompt exists at backend/app/prompts/generate_stories_classic_v1.txt",
        "Job story format prompt exists at backend/app/prompts/generate_stories_job_v1.txt",
        "Classic prompt uses 'As a [user], I want [goal], so that [benefit]' format",
        "Job story prompt uses 'When [situation], I want to [action], so I can [outcome]' format",
        "Both prompts specify JSON output with stories array containing title, description, acceptance_criteria, suggested_size, suggested_labels, source_requirement_ids",
        "Prompts include {requirements_by_section} placeholder"
      ],
      "priority": 16,
      "passes": true,
      "notes": "Prompts should instruct LLM to follow INVEST principles and create sprint-sized stories."
    },
    {
      "id": "US-017",
      "title": "Implement StoriesGenerator service with background tasks",
      "description": "As a developer, I want a StoriesGenerator service class, so that story generation can be performed asynchronously with batch tracking.",
      "acceptanceCriteria": [
        "StoriesGenerator service exists at backend/app/services/stories_generator.py",
        "generate() method loads requirements, builds prompt, calls LLM, creates UserStory records",
        "_get_next_story_number() uses row-level lock to prevent duplicate story numbers",
        "_load_requirements() supports optional section_filter",
        "_parse_response() extracts stories array from LLM response",
        "Story numbers are never reused even for deleted stories",
        "Background task function generate_stories_task() handles status transitions correctly",
        "batch.story_count is updated after generation completes",
        "Background task checks for cancelled status before and after LLM call to prevent saving results if cancelled",
        "LLM configuration uses temperature=0.5, max_tokens=4000, timeout=90 for story generation"
      ],
      "priority": 17,
      "passes": true,
      "notes": "Use with_for_update() for row locking on story number. Check for cancelled status before starting. LLM config should be centralized in config/llm.py or similar."
    },
    {
      "id": "US-018",
      "title": "Create stories router with all endpoints",
      "description": "As a developer, I want a stories router with CRUD and generation endpoints, so that the frontend can interact with story features.",
      "acceptanceCriteria": [
        "Stories router exists at backend/app/routers/stories.py",
        "POST /projects/{project_id}/stories/generate creates batch with status=queued and returns immediately",
        "GET /stories/batches/{batch_id}/status returns current batch generation status",
        "POST /stories/batches/{batch_id}/cancel sets batch status=cancelled if queued or generating",
        "GET /projects/{project_id}/stories lists stories with pagination, batch_id, status, and labels filters",
        "GET /projects/{project_id}/stories/batches lists all generation batches",
        "GET /stories/{story_id} returns single story",
        "PUT /stories/{story_id} updates story details",
        "DELETE /stories/{story_id} soft deletes story",
        "POST /projects/{project_id}/stories/reorder updates story order",
        "DELETE /projects/{project_id}/stories/batch/{batch_id} deletes all stories in batch",
        "GET /projects/{project_id}/stories/export returns stories in markdown, CSV, or JSON format",
        "All stories read/write endpoints enforce project access for the current user"
      ],
      "priority": 18,
      "passes": true,
      "notes": "CSV export should have pipe-separated acceptance criteria. Use BackgroundTasks for generation."
    },
    {
      "id": "US-019",
      "title": "Register stories router in main.py",
      "description": "As a developer, I want the stories router registered in the FastAPI app, so that story endpoints are accessible.",
      "acceptanceCriteria": [
        "stories router is imported in backend/app/main.py",
        "stories router is included with app.include_router()",
        "All stories endpoints are accessible via API",
        "OpenAPI docs show stories endpoints under 'stories' tag"
      ],
      "priority": 19,
      "passes": true,
      "notes": "Follow the pattern used for existing routers in main.py."
    },
    {
      "id": "US-020",
      "title": "Create StoriesLandingPage with project selection",
      "description": "As a user, I want a stories landing page where I can select a project, so that I can start story generation for any project.",
      "acceptanceCriteria": [
        "StoriesLandingPage component exists at ui/src/pages/StoriesLandingPage.jsx",
        "Page displays feature description and purpose",
        "Project selector dropdown shows all available projects",
        "Selecting a project navigates to /app/projects/{projectId}/stories",
        "Page handles loading and error states for project list",
        "API service functions added to ui/src/services/api.js: generateStories(), getBatchStatus(), cancelStoryGeneration(), listStories(), getStory(), updateStory(), deleteStory(), listBatches(), deleteBatch(), reorderStories(), exportStories()"
      ],
      "priority": 20,
      "passes": true,
      "notes": "Follow PRDLandingPage patterns. Reuse project selector component if available. API functions should follow existing patterns in api.js."
    },
    {
      "id": "US-021",
      "title": "Create UserStoriesPage with options panel",
      "description": "As a user, I want a stories page with format selection and generation status, so that I can generate and view user stories.",
      "acceptanceCriteria": [
        "UserStoriesPage component exists at ui/src/pages/UserStoriesPage.jsx",
        "Format selector shows Classic and Job Story options with descriptions",
        "Optional section filter multi-select for requirement sections",
        "Generate button starts generation and shows loading state",
        "30-second cooldown prevents rapid re-generation",
        "Progress overlay shows during generation with cancel button",
        "Status polling every 2 seconds until generation completes",
        "Stories list displays all stories for the project",
        "Info dialog warns that regeneration adds stories (doesn't replace)"
      ],
      "priority": 21,
      "passes": true,
      "notes": "Unlike PRD, stories append on regeneration. Show info dialog before generate to clarify this behavior."
    },
    {
      "id": "US-022",
      "title": "Create StoryCard component with expand/collapse",
      "description": "As a user, I want expandable story cards, so that I can quickly scan stories and drill into details.",
      "acceptanceCriteria": [
        "StoryCard component exists at ui/src/components/stories/StoryCard.jsx",
        "Collapsed view shows story ID badge (US-001), title, size indicator, label chips",
        "Expanded view shows full description and acceptance criteria",
        "Click to expand/collapse",
        "Quick actions: Edit button, Delete button",
        "Delete button shows confirmation dialog before deleting"
      ],
      "priority": 22,
      "passes": true,
      "notes": "Use existing card component patterns. Story ID should be visually prominent."
    },
    {
      "id": "US-023",
      "title": "Create StoryEditModal with all fields",
      "description": "As a user, I want a story edit modal, so that I can modify all story details.",
      "acceptanceCriteria": [
        "StoryEditModal component exists at ui/src/components/stories/StoryEditModal.jsx",
        "Title field is editable",
        "Description field is editable with multiline input",
        "Acceptance criteria list with add/remove/reorder functionality",
        "Size selector dropdown (XS, S, M, L, XL)",
        "Labels multi-select with ability to create new labels",
        "Status selector dropdown (Draft, Ready, Exported)",
        "Save and Cancel buttons",
        "Warning shown when closing with unsaved changes"
      ],
      "priority": 23,
      "passes": true,
      "notes": "Consider using a drag-and-drop library for acceptance criteria reordering."
    },
    {
      "id": "US-024",
      "title": "Create StoriesExportModal with format options",
      "description": "As a user, I want to export stories in multiple formats, so that I can use them in other tools.",
      "acceptanceCriteria": [
        "StoriesExportModal component exists at ui/src/components/stories/StoriesExportModal.jsx",
        "Format selector shows Markdown, CSV, JSON options",
        "Optional batch filter to export specific batch only",
        "Download button triggers file download",
        "Filename includes project name and format extension"
      ],
      "priority": 24,
      "passes": true,
      "notes": "CSV format uses pipe separators for acceptance criteria column."
    },
    {
      "id": "US-025",
      "title": "Create StoryBatchFilter for batch management",
      "description": "As a user, I want to filter stories by generation batch, so that I can manage stories from different generation runs.",
      "acceptanceCriteria": [
        "StoryBatchFilter component exists at ui/src/components/stories/StoryBatchFilter.jsx",
        "Dropdown shows 'All stories' and each batch with creation date and story count",
        "Selecting a batch filters the story list",
        "Delete batch option in dropdown (with confirmation)",
        "Deleting batch removes all stories in that batch"
      ],
      "priority": 25,
      "passes": true,
      "notes": "Batch deletion confirmation should show number of stories that will be deleted."
    },
    {
      "id": "US-026",
      "title": "Update LandingPage to enable Stories card",
      "description": "As a user, I want to see an enabled Stories card on the landing page, so that I can navigate to the stories feature.",
      "acceptanceCriteria": [
        "User Stories feature card exists in LandingPage.jsx",
        "Card has title 'User Stories' and description",
        "Card links to /app/stories",
        "Card is enabled (not grayed out)"
      ],
      "priority": 26,
      "passes": true,
      "notes": "Find the features array in LandingPage.jsx and update the Stories card to enabled: true."
    },
    {
      "id": "US-027",
      "title": "Add stories routes to App.jsx",
      "description": "As a developer, I want stories routes configured in the router, so that stories pages are accessible via URL navigation.",
      "acceptanceCriteria": [
        "Route /app/stories renders StoriesLandingPage",
        "Route /app/projects/:projectId/stories renders UserStoriesPage",
        "All routes are protected by authentication"
      ],
      "priority": 27,
      "passes": true,
      "notes": "Follow existing route patterns in App.jsx. Import the new page components."
    },
    {
      "id": "US-028",
      "title": "Backend unit tests for PRD service",
      "description": "As a developer, I want unit tests for the PRD generator service, so that core functionality is verified.",
      "acceptanceCriteria": [
        "Test file exists at backend/tests/test_prd_service.py",
        "test_generate_prd_draft_mode verifies draft sections are generated",
        "test_generate_prd_detailed_mode verifies all 12 sections are generated",
        "test_version_auto_increment verifies version increments per project",
        "test_version_increment_with_concurrency verifies row lock prevents duplicates",
        "test_no_requirements_raises_error verifies NoRequirementsError",
        "test_malformed_llm_response verifies LLMResponseError",
        "Mock LLM responses are used for consistent testing"
      ],
      "priority": 28,
      "passes": true,
      "notes": "Use pytest fixtures for mock_llm and db_session. See implementation plan for mock response format."
    },
    {
      "id": "US-029",
      "title": "Backend integration tests for PRD endpoints",
      "description": "As a developer, I want integration tests for PRD API endpoints, so that the full request/response cycle is verified.",
      "acceptanceCriteria": [
        "Test file exists at backend/tests/test_prd_api.py",
        "test_generate_returns_queued_status verifies POST /generate returns status=queued",
        "test_status_polling verifies GET /status returns correct status",
        "test_cancel_generation verifies POST /cancel sets status=cancelled",
        "test_list_prds_pagination verifies skip/limit parameters work",
        "test_soft_delete_prd verifies DELETE sets deleted_at and excludes from list",
        "test_export_markdown verifies export returns valid markdown",
        "Tests use test client and mock LLM"
      ],
      "priority": 29,
      "passes": true,
      "notes": "Use FastAPI TestClient. Create fixtures for project_with_requirements and existing_prd."
    },
    {
      "id": "US-030",
      "title": "Backend unit tests for Stories service",
      "description": "As a developer, I want unit tests for the stories generator service, so that story generation logic is verified.",
      "acceptanceCriteria": [
        "Test file exists at backend/tests/test_stories_service.py",
        "test_generate_stories_classic_format verifies classic format stories are generated",
        "test_generate_stories_job_format verifies job story format is used",
        "test_story_number_never_reused verifies deleted story numbers aren't reused",
        "test_story_number_with_concurrency verifies row lock prevents duplicates",
        "test_section_filter verifies only filtered requirements are used",
        "Mock LLM responses are used for consistent testing"
      ],
      "priority": 30,
      "passes": true,
      "notes": "Create mock response with multiple stories. Test that story_number continues from max even after deletions."
    },
    {
      "id": "US-031",
      "title": "Frontend component tests",
      "description": "As a developer, I want unit tests for frontend components, so that UI behavior is verified.",
      "acceptanceCriteria": [
        "Tests exist for PRDGeneratorPage component",
        "Tests verify mode selection updates state",
        "Tests verify generate button triggers API call",
        "Tests verify cooldown disables button for 30 seconds",
        "Tests exist for StoryCard component",
        "Tests verify expand/collapse behavior",
        "Tests verify edit and delete actions",
        "Tests use React Testing Library"
      ],
      "priority": 31,
      "passes": true,
      "notes": "Mock API calls and timers. Test accessibility with @testing-library/jest-dom."
    },
    {
      "id": "US-032",
      "title": "E2E tests with Playwright",
      "description": "As a developer, I want end-to-end tests for the complete generation flow, so that user workflows are verified.",
      "acceptanceCriteria": [
        "Test file exists at ui/e2e/prd-generation.spec.ts",
        "Test file exists at ui/e2e/stories-generation.spec.ts",
        "PRD test covers: navigate to landing, select project, choose mode, generate, wait for completion, verify editor loads",
        "PRD test verifies section editing and auto-save",
        "Stories test covers: navigate to landing, select project, choose format, generate, wait for completion, verify stories list",
        "Stories test verifies story card expand and edit modal",
        "Tests use appropriate data-testid attributes",
        "Tests handle async generation with proper timeouts"
      ],
      "priority": 32,
      "passes": true,
      "notes": "Use Playwright's toBeVisible with longer timeout for generation. Mock LLM in CI for faster tests."
    },
    {
      "id": "US-033",
      "title": "Define export schemas for PRD and Stories",
      "description": "As a developer, I want explicit export schemas for PRDs and stories, so that JSON/CSV outputs are consistent and testable.",
      "acceptanceCriteria": [
        "PRD export JSON schema is documented in code or tests (fields, types, ordering)",
        "Stories export JSON schema is documented in code or tests (fields, types, ordering)",
        "Stories CSV mapping is documented (column names, acceptance criteria formatting rules)",
        "Export endpoints conform to the documented schemas"
      ],
      "priority": 33,
      "passes": true,
      "notes": "Keep v1 scope to Markdown/JSON/CSV only. Use acceptance criteria formatting rule from plan (pipe-separated)."
    },
    {
      "id": "US-034",
      "title": "Enforce project access for PRD and Story endpoints",
      "description": "As a developer, I want consistent access checks on all PRD and story endpoints, so that users can only access their projects.",
      "acceptanceCriteria": [
        "All PRD endpoints verify the current user has access to the project or resource",
        "All story endpoints verify the current user has access to the project or resource",
        "Unauthorized access returns appropriate HTTP status (401/403) per existing patterns"
      ],
      "priority": 34,
      "passes": true,
      "notes": "Follow existing project access patterns. Ensure read/list endpoints enforce access."
    },
    {
      "id": "US-035",
      "title": "Make PRD version assignment atomic at creation",
      "description": "As a developer, I want PRD version assignment to be atomic during record creation, so that concurrent generations never collide on version.",
      "acceptanceCriteria": [
        "PRD version is assigned inside a single transaction with row-level lock",
        "Concurrent PRD generations for the same project produce distinct versions",
        "No duplicate versions exist for a single project"
      ],
      "priority": 35,
      "passes": true,
      "notes": "Ensure version generation is tied to record creation rather than a separate service call."
    },
    {
      "id": "US-036",
      "title": "Backend integration tests for Stories API endpoints",
      "description": "As a developer, I want integration tests for Stories API endpoints, so that the full request/response cycle is verified.",
      "acceptanceCriteria": [
        "Test file exists at backend/tests/test_stories_api.py",
        "test_generate_returns_queued_status verifies POST /generate returns batch with status=queued",
        "test_batch_status_polling verifies GET /batches/{id}/status returns correct status",
        "test_cancel_batch verifies POST /batches/{id}/cancel sets status=cancelled",
        "test_list_stories_pagination verifies skip/limit parameters work",
        "test_list_stories_filters verifies batch_id, status, and labels filters work",
        "test_soft_delete_story verifies DELETE sets deleted_at and excludes from list",
        "test_delete_batch verifies all stories in batch are deleted",
        "test_reorder_stories verifies order is updated correctly",
        "test_export_csv verifies CSV export has correct columns and pipe-separated acceptance criteria",
        "test_export_json verifies JSON export matches schema",
        "Tests use test client and mock LLM"
      ],
      "priority": 36,
      "passes": true,
      "notes": "Use FastAPI TestClient. Create fixtures for project_with_requirements, existing_batch, and existing_stories."
    },
    {
      "id": "US-037",
      "title": "Error handling edge cases",
      "description": "As a developer, I want comprehensive error handling for edge cases, so that the system fails gracefully with helpful messages.",
      "acceptanceCriteria": [
        "Generation with no requirements returns helpful error message (not generic 500)",
        "LLM timeout sets status=failed with timeout-specific error message",
        "Malformed LLM response sets status=failed with parsing error details",
        "Concurrent version/story number conflicts are handled by retry or lock (no duplicates)",
        "Attempting to cancel already-completed generation returns appropriate response",
        "Attempting to edit/delete non-existent resource returns 404",
        "Frontend displays user-friendly error messages for all failure states",
        "Failed generation allows retry without page refresh"
      ],
      "priority": 37,
      "passes": true,
      "notes": "Test these scenarios in both unit and integration tests. Frontend should map error codes to user-friendly messages."
    },
    {
      "id": "US-038",
      "title": "Fix story number locking to prevent duplicates in concurrent generation",
      "description": "As a developer, I want story number assignment to be atomic for the entire batch, so that concurrent story generations never produce duplicate story numbers.",
      "acceptanceCriteria": [
        "Row-level lock on Project is acquired BEFORE the loop that creates stories",
        "Lock is held for the entire batch of stories, not acquired/released per story",
        "All stories in a batch are assigned sequential numbers in a single transaction",
        "_get_next_story_number() is called once with count parameter, or lock is moved outside loop",
        "Concurrent generation requests for same project produce non-overlapping story numbers",
        "Test verifies no duplicate story_number values exist for a project after concurrent generations",
        "Background task generate_stories_task() also uses the atomic batch approach"
      ],
      "priority": 38,
      "passes": true,
      "notes": "FIXED: Replaced _get_next_story_number() with _reserve_story_numbers(project_id, count) that reserves all story numbers atomically before the loop. Lock is held until transaction commits."
    },
    {
      "id": "US-039",
      "title": "Fix labels filter to use proper JSON array matching",
      "description": "As a developer, I want the labels filter to correctly match labels in JSON arrays, so that filtering by label returns only stories that actually have that label.",
      "acceptanceCriteria": [
        "Filtering by label 'frontend' does NOT match stories with label 'not-frontend'",
        "Filtering by label 'api' does NOT match stories with label 'api-v2' or 'legacy-api'",
        "Labels filter correctly handles labels at any position in the array",
        "Labels filter works with single label and multiple labels",
        "Test case added: story with labels ['not-frontend', 'backend'] is NOT returned when filtering by 'frontend'",
        "Test case added: story with labels ['frontend', 'api'] IS returned when filtering by 'frontend'"
      ],
      "priority": 39,
      "passes": true,
      "notes": "FIXED: Replaced simple LIKE pattern with exact array element matching using OR conditions for all positions (single element, first, middle, last) with both space and no-space variants to handle JSON serialization differences."
    },
    {
      "id": "US-040",
      "title": "Apply LLM configuration parameters to provider calls",
      "description": "As a developer, I want LLM configuration (timeout, temperature, max_tokens) to be applied when calling the provider, so that generation has proper timeout protection and consistent behavior.",
      "acceptanceCriteria": [
        "PRD_LLM_TIMEOUT (120s) is passed to provider and enforced during PRD generation",
        "PRD_LLM_TEMPERATURE (0.7) is passed to provider for PRD generation",
        "PRD_LLM_MAX_TOKENS (8000) is passed to provider for PRD generation",
        "STORIES_LLM_TIMEOUT (90s) is passed to provider and enforced during story generation",
        "STORIES_LLM_TEMPERATURE (0.5) is passed to provider for story generation",
        "STORIES_LLM_MAX_TOKENS (4000) is passed to provider for story generation",
        "LLM provider's generate() method accepts timeout, temperature, max_tokens parameters",
        "If LLM call exceeds timeout, GenerationTimeoutError or LLMError with timeout message is raised",
        "Test verifies timeout is enforced (mock slow LLM response)"
      ],
      "priority": 40,
      "passes": true,
      "notes": "FIXED: Updated LLMProvider base class and all implementations (Claude, Ollama) to accept temperature, max_tokens, timeout in generate(). Updated prd_generator.py and stories_generator.py to pass their respective config constants. Added TimeoutLLMProvider mock and comprehensive tests."
    },
    {
      "id": "US-041",
      "title": "Add database unique constraints for version and story number",
      "description": "As a developer, I want database-level unique constraints on PRD version and story number, so that data integrity is enforced even if application logic fails.",
      "acceptanceCriteria": [
        "Unique constraint exists on (project_id, version) for prds table",
        "Unique constraint exists on (project_id, story_number) for user_stories table",
        "Alembic migration adds both constraints",
        "Attempting to insert duplicate version raises IntegrityError",
        "Attempting to insert duplicate story_number raises IntegrityError",
        "Existing data passes constraint validation (no duplicates exist)",
        "Migration can be rolled back"
      ],
      "priority": 41,
      "passes": true,
      "notes": "SHOULD FIX for v1. Provides defense-in-depth against race conditions. Application logic handles uniqueness, but DB constraint is the safety net. Use CREATE UNIQUE INDEX for the constraints."
    },
    {
      "id": "US-042",
      "title": "Add session rollback before error status commit in background tasks",
      "description": "As a developer, I want background tasks to rollback any pending transaction before committing error status, so that failed operations don't leave the database in an inconsistent state.",
      "acceptanceCriteria": [
        "generate_prd_task() calls db.rollback() before setting status=failed and committing",
        "generate_stories_task() calls db.rollback() before setting status=failed and committing",
        "Rollback is called in each exception handler before the error commit",
        "Test verifies that partial story creation is rolled back on error",
        "Test verifies that PRD in bad state is cleaned up on error",
        "After rollback, only the error status update is committed"
      ],
      "priority": 42,
      "passes": true,
      "notes": "FIXED: Added db.rollback() in each exception handler in both generate_prd_task() and generate_stories_task(). After rollback, re-fetch the PRD/batch from database to re-attach to session before updating error status and committing."
    }
  ]
}
